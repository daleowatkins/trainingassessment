<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Lion Training Assessment</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        :root {
            --lion-gold: #D4AF37;
            --lion-dark: #1a202c;
        }
        .text-lion-gold { color: var(--lion-gold); }
        .bg-lion-gold { background-color: var(--lion-gold); }
        .border-lion-gold { border-color: var(--lion-gold); }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { border-top-color: var(--lion-gold); -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dropdown styles */
        .custom-dropdown {
            max-height: 0;
            transition: max-height 0.2s ease-out;
            overflow: hidden;
        }
        .custom-dropdown.open {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Modal Background */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- NAVIGATION -->
    <nav class="bg-gray-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="window.app.logout()">
                    <i class="fas fa-lion text-lion-gold text-2xl mr-3"></i>
                    <span class="text-xl font-bold tracking-wider">COUNTRY LION <span class="text-lion-gold">TRAINING</span></span>
                </div>
                <div id="nav-buttons" class="flex items-center">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 relative">
        <div id="app">
            <!-- Content injected here -->
        </div>
        
        <!-- Global Loading Overlay -->
        <div id="global-loader" class="hidden absolute inset-0 bg-gray-50 bg-opacity-80 flex justify-center items-center z-50 fixed h-full w-full">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
        </div>

        <!-- CUSTOM MODAL OVERLAY -->
        <div id="custom-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl max-w-md w-full overflow-hidden fade-in transform scale-100">
                <div class="p-6">
                    <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-2">Confirm Action</h3>
                    <p id="modal-text" class="text-gray-600 mb-6">Are you sure?</p>
                    <div id="modal-buttons" class="flex justify-end space-x-3">
                        <!-- Buttons injected here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-800 text-gray-500 py-6 text-center text-sm mt-auto">
        <p>&copy; 2026 Country Lion Training Assessment. Version 1.8.6</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtal9zPioR5LXlHRn3IqGQ2OML5DBXg2A",
            authDomain: "assessments-89dd7.firebaseapp.com",
            projectId: "assessments-89dd7",
            storageBucket: "assessments-89dd7.firebasestorage.app",
            messagingSenderId: "700097828470",
            appId: "1:700097828470:web:95a92b50b3a0ca59ebb157"
        };

        // --- EMAILJS CONFIGURATION ---
        const emailConfig = {
            serviceID: "service_b0zzpkb",
            templateID: "template_tq4tz6p", 
            publicKey: "zt6NEchi0KdWgUqJ9"
        };

        // --- APP SETTINGS ---
        const APP_PUBLIC_URL = "https://daleowatkins.github.io/trainingassessment/"; 

        // Initialize Firebase
        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            console.log("Firebase Connected");
        } catch (error) {
            console.error("Firebase Init Error:", error);
            alert("Database connection failed. Check console.");
        }

        // --- DATABASE SERVICE ---
        const DB = {
            // Seed default data if DB is empty
            seedDefaults: async () => {
                const usersSnap = await getDocs(collection(db, "users"));
                if (!usersSnap.empty) return; 

                console.log("Seeding default data...");
                const defaultUsers = [
                    { id: 'u1', name: "John Doe", username: "jdoe", pin: "1234", email: "john@example.com", role: 'learner', assigned: [1, 2], assignedCourses: [101], archived: false },
                    { id: 'u_admin', name: "System Admin", username: "admin", pin: "0000", email: "admin@example.com", role: 'admin', assigned: [1, 2], assignedCourses: [101], archived: false }
                ];
                const defaultQuizzes = [
                    { 
                        id: 1, title: "Site Safety Induction", desc: "Mandatory safety protocols.", displayCount: 3, passMark: 2,
                        introText: "Welcome to the Site Safety Induction. Please review the safety handbook before proceeding.",
                        questions: [
                            { q: "What color is a prohibition sign?", options: ["Red", "Green", "Blue", "Yellow"], ans: 0, explain: "Prohibition signs are Red." },
                            { q: "What should you do on fire alarm?", options: ["Finish work", "Evacuate", "Hide"], ans: 1, explain: "Evacuate immediately." },
                            { q: "Who is responsible for your PPE?", options: ["Manager", "You", "Client"], ans: 1, explain: "You are responsible." }
                        ]
                    },
                    {
                        id: 2, title: "Manual Handling", desc: "Lifting techniques.", displayCount: 2, passMark: 1,
                        questions: [
                            { q: "Max weight for one person?", options: ["25kg", "50kg", "No limit"], ans: 0, explain: "25kg guideline." },
                            { q: "Keep load...", options: ["Away", "Close to waist", "Above head"], ans: 1, explain: "Keep close to center of gravity." }
                        ]
                    }
                ];
                const defaultCourses = [
                    {
                        id: 101, title: "Company Orientation", desc: "Welcome to the team.", linkedQuizId: null,
                        slides: [
                            { title: "Welcome", content: "Welcome to Country Lion. We are glad to have you.", mediaUrl: "" },
                            { title: "Our Values", content: "Safety, Reliability, and Customer Service.", mediaUrl: "" }
                        ]
                    }
                ];

                for (const u of defaultUsers) await setDoc(doc(db, "users", u.id), u);
                for (const q of defaultQuizzes) await setDoc(doc(db, "quizzes", String(q.id)), q);
                for (const c of defaultCourses) await setDoc(doc(db, "courses", String(c.id)), c);
                console.log("Seeding complete.");
            },

            getAll: async (collName) => {
                const querySnapshot = await getDocs(collection(db, collName));
                let data = [];
                querySnapshot.forEach((doc) => data.push(doc.data()));
                return data;
            },

            getById: async (collName, id) => {
                const docRef = doc(db, collName, String(id));
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            },

            save: async (collName, data) => {
                await setDoc(doc(db, collName, String(data.id || data.resultId)), data);
            },

            delete: async (collName, id) => {
                await deleteDoc(doc(db, collName, String(id)));
            },

            // New method to estimate storage size
            getStorageEstimate: async () => {
                let totalBytes = 0;
                const collections = ["users", "quizzes", "courses", "results"];
                for (const col of collections) {
                    const snap = await getDocs(collection(db, col));
                    snap.forEach(doc => {
                        // Rough estimation based on JSON string length
                        totalBytes += JSON.stringify(doc.data()).length;
                    });
                }
                return totalBytes;
            }
        };

        // --- APP LOGIC ---
        const App = {
            currentUser: null,
            currentQuizSession: null,
            currentCourseSession: null, 
            activeTab: 'assessments', 
            editingUser: null,
            editingQuiz: null,
            editingCourse: null,
            viewArchived: false,

            init: async () => {
                if (emailConfig.publicKey !== "YOUR_PUBLIC_KEY" && window.emailjs) {
                    emailjs.init(emailConfig.publicKey);
                }

                App.showLoader(true);
                try {
                    await DB.seedDefaults();
                    App.render('login');
                } catch (e) {
                    console.error(e);
                    document.getElementById('app').innerHTML = `<div class="text-center text-red-600 mt-10">Failed to connect to database.<br>Check console for details.</div>`;
                } finally {
                    App.showLoader(false);
                }

                window.addEventListener('click', (e) => {
                    const dropdowns = ['quizInputContainer', 'courseInputContainer']; 
                    dropdowns.forEach(id => {
                        const container = document.getElementById(id);
                        if (container) {
                             const specificDropdown = document.getElementById(id === 'quizInputContainer' ? 'quizDropdown' : 'courseDropdown'); 
                             if (specificDropdown && !container.contains(e.target)) specificDropdown.classList.add('hidden');
                        }
                    });
                });
            },

            showLoader: (show) => {
                const el = document.getElementById('global-loader');
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },

            // --- CUSTOM MODAL SYSTEM ---
            showModal: (title, msg, isConfirm, onYes) => {
                 const m = document.getElementById('custom-modal');
                 document.getElementById('modal-title').textContent = title;
                 document.getElementById('modal-text').textContent = msg;
                 
                 const btnContainer = document.getElementById('modal-buttons');
                 btnContainer.innerHTML = ''; 
                 
                 if (isConfirm) {
                     const yes = document.createElement('button');
                     yes.className = "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition";
                     yes.textContent = "Yes, Proceed";
                     yes.onclick = () => { m.classList.add('hidden'); if(onYes) onYes(); };
                     
                     const no = document.createElement('button');
                     no.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition";
                     no.textContent = "Cancel";
                     no.onclick = () => m.classList.add('hidden');
                     
                     btnContainer.appendChild(no);
                     btnContainer.appendChild(yes);
                 } else {
                     const ok = document.createElement('button');
                     ok.className = "bg-lion-gold hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition";
                     ok.textContent = "OK";
                     ok.onclick = () => { m.classList.add('hidden'); if(onYes) onYes(); };
                     btnContainer.appendChild(ok);
                 }
                 
                 m.classList.remove('hidden');
            },

            updateNav: () => {
                const nav = document.getElementById('nav-buttons');
                if (App.currentUser) {
                    const roleBadge = App.currentUser.role === 'admin' 
                        ? `<span class="bg-lion-gold text-gray-900 text-xs px-2 py-1 rounded font-bold mr-2">ADMIN</span>` 
                        : '';
                    const adminLink = App.currentUser.role === 'admin'
                        ? `<button onclick="window.app.render('adminDashboard')" class="mr-4 text-sm font-bold text-lion-gold hover:text-yellow-400 transition"><i class="fas fa-tools mr-1"></i> Admin Panel</button>`
                        : '';
                    nav.innerHTML = `<div class="flex items-center">${roleBadge}${adminLink}<span class="mr-4 text-sm text-gray-400 hidden sm:block">${App.currentUser.name}</span><button onclick="window.app.logout()" class="text-sm border border-gray-600 hover:border-white text-gray-300 hover:text-white px-3 py-1 rounded transition">Logout</button></div>`;
                } else {
                    nav.innerHTML = '';
                }
            },
            
            // --- TEXT FORMATTING HELPER ---
            insertFormat: (btn, format) => {
                const textarea = btn.closest('.slide-block').querySelector('.s-content');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const selection = text.substring(start, end);
                
                let insert = '';
                let newCursorPos = start;

                if (['üòÄ','üëç','‚úÖ','‚≠ê','‚ö†Ô∏è','üî¥','üü¢'].includes(format)) {
                     insert = format;
                     textarea.value = text.substring(0, start) + insert + text.substring(end);
                     newCursorPos = start + insert.length;
                } else {
                    if (format === 'bold') insert = `<b>${selection}</b>`;
                    if (format === 'italic') insert = `<i>${selection}</i>`;
                    if (format === 'underline') insert = `<u>${selection}</u>`;
                    if (format === 'list') insert = `<ul>\n<li>${selection}</li>\n</ul>`;
                    textarea.value = text.substring(0, start) + insert + text.substring(end);
                    newCursorPos = end + insert.length;
                }
                
                textarea.focus();
                textarea.selectionStart = newCursorPos;
                textarea.selectionEnd = newCursorPos;
            },

            render: async (viewName, data = null) => {
                const container = document.getElementById('app');
                App.showLoader(true);
                App.updateNav();

                // HELPER FOR ESCAPING QUOTES IN INPUT VALUES
                const safe = (str) => String(str || '').replace(/"/g, '&quot;');
                
                try {
                    switch(viewName) {
                        case 'login':
                            container.innerHTML = `
                                <div class="max-w-md mx-auto mt-10 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <div class="text-center mb-6">
                                        <i class="fas fa-user-circle text-5xl text-gray-300 mb-2"></i>
                                        <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                                        <p class="text-gray-500 text-sm">Enter your Username and PIN</p>
                                    </div>
                                    <form onsubmit="event.preventDefault(); window.app.handleLogin()" class="space-y-4">
                                        <div><label class="block text-gray-600 text-xs font-bold mb-1 uppercase">Username</label><input type="text" id="loginUsername" placeholder="e.g. jdoe" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-lion-gold transition"></div>
                                        <div><label class="block text-gray-600 text-xs font-bold mb-1 uppercase">PIN</label><input type="password" id="loginPin" placeholder="****" maxlength="4" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-lion-gold transition font-mono tracking-widest"></div>
                                        <button type="submit" class="w-full bg-lion-gold hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow transition transform hover:scale-[1.02]">Log In</button>
                                    </form>
                                </div>`;
                            break;

                        case 'dashboard':
                            if (!App.currentUser) return App.render('login');
                            const allQuizzes = await DB.getAll("quizzes");
                            const allCourses = await DB.getAll("courses"); 
                            const allResults = await DB.getAll("results");
                            const userHistory = allResults.filter(r => r.userId === App.currentUser.id);
                            
                            const tabClass = (isActive) => isActive ? "border-b-2 border-lion-gold text-gray-900" : "text-gray-500 hover:text-gray-700";
                            
                            let contentHTML = "";

                            if (App.activeTab === 'assessments') {
                                const myQuizzes = allQuizzes.filter(q => (App.currentUser.assigned || []).includes(q.id));
                                let quizCards = myQuizzes.map(q => {
                                    const attempts = userHistory.filter(h => h.quizId === q.id && h.type !== 'course');
                                    const lastAttempt = attempts.length ? attempts[attempts.length-1] : null;
                                    const isPassed = lastAttempt && lastAttempt.passed;
                                    
                                    const linkedCourse = allCourses.find(c => c.linkedQuizId === q.id);
                                    const courseBtn = linkedCourse ? `<button onclick="window.app.startCourse(${linkedCourse.id})" class="mt-2 w-full bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded hover:bg-gray-50"><i class="fas fa-book mr-2"></i> Review Course</button>` : '';

                                    return `
                                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300 flex flex-col h-full border-l-4 ${isPassed ? 'border-green-500' : 'border-lion-gold'}">
                                            <div class="p-6 flex-grow">
                                                <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl text-gray-800">${q.title}</h3>${isPassed ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">COMPLETED</span>' : '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">PENDING</span>'}</div>
                                                <p class="text-gray-600 text-sm mb-4">${q.desc}</p>
                                                <div class="text-xs text-gray-500">Pass Mark: ${q.passMark || 'N/A'}<br>Last Score: ${lastAttempt ? lastAttempt.score + '%' : 'Not taken'}</div>
                                            </div>
                                            <div class="bg-gray-50 p-4 border-t border-gray-100">
                                                <button onclick="window.app.startQuiz(${q.id})" class="w-full ${isPassed ? 'bg-gray-200 text-gray-600' : 'bg-gray-800 text-white hover:bg-gray-900'} font-bold py-2 rounded transition flex justify-center items-center">${isPassed ? 'Retake Assessment' : 'Start Assessment <i class="fas fa-arrow-right ml-2"></i>'}</button>
                                                ${courseBtn}
                                            </div>
                                        </div>`;
                                }).join('');
                                if(myQuizzes.length === 0) quizCards = `<div class="col-span-3 text-center py-10 text-gray-500">No assessments assigned.</div>`;
                                contentHTML = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${quizCards}</div>`;
                            } else {
                                // COURSES TAB
                                const myCourses = allCourses.filter(c => (App.currentUser.assignedCourses || []).includes(c.id));
                                let courseCards = myCourses.map(c => {
                                    const completed = userHistory.some(h => h.courseId === c.id && h.type === 'course');
                                    const linkedQuizId = c.linkedQuizId;
                                    const quizBtn = linkedQuizId ? `<button onclick="window.app.startQuiz(${linkedQuizId})" class="mt-2 w-full bg-lion-gold text-white font-bold py-2 rounded hover:bg-yellow-600"><i class="fas fa-clipboard-check mr-2"></i> Take Assessment</button>` : '';
                                    
                                    return `
                                        <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300 flex flex-col h-full border-l-4 ${completed ? 'border-green-500' : 'border-blue-500'}">
                                            <div class="p-6 flex-grow">
                                                <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl text-gray-800">${c.title}</h3>${completed ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">COMPLETED</span>' : '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">COURSE</span>'}</div>
                                                <p class="text-gray-600 text-sm mb-4">${c.desc}</p>
                                                <div class="text-xs text-gray-500">${c.slides ? c.slides.length : 0} Slides</div>
                                            </div>
                                            <div class="bg-gray-50 p-4 border-t border-gray-100">
                                                <button onclick="window.app.startCourse(${c.id})" class="w-full bg-gray-800 text-white hover:bg-gray-900 font-bold py-2 rounded transition flex justify-center items-center">${completed ? 'Review Course' : 'Start Course <i class="fas fa-play ml-2"></i>'}</button>
                                                ${quizBtn}
                                            </div>
                                        </div>`;
                                }).join('');
                                if(myCourses.length === 0) courseCards = `<div class="col-span-3 text-center py-10 text-gray-500">No training courses assigned.</div>`;
                                contentHTML = `<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${courseCards}</div>`;
                            }

                            container.innerHTML = `
                                <div class="fade-in">
                                    <div class="bg-white p-6 rounded-lg shadow-sm mb-8 border-b border-gray-200">
                                        <h1 class="text-3xl font-bold text-gray-800">Welcome, <span class="text-lion-gold">${App.currentUser.name}</span></h1>
                                        
                                        <!-- Tabs -->
                                        <div class="flex space-x-6 mt-6 border-b border-gray-200">
                                            <button onclick="window.app.switchTab('assessments')" class="pb-2 font-medium transition ${tabClass(App.activeTab === 'assessments')}">Assessments</button>
                                            <button onclick="window.app.switchTab('courses')" class="pb-2 font-medium transition ${tabClass(App.activeTab === 'courses')}">Training Courses</button>
                                        </div>
                                    </div>
                                    ${contentHTML}
                                </div>`;
                            break;

                        case 'coursePlayer':
                            const cSession = App.currentCourseSession;
                            if(!cSession) return App.render('dashboard');
                            
                            const currentSlide = cSession.slides[cSession.currentIndex];
                            const progress = ((cSession.currentIndex + 1) / cSession.slides.length) * 100;
                            
                            const contentsList = cSession.slides.map((s, idx) => `
                                <div onclick="window.app.jumpToSlide(${idx})" class="p-3 cursor-pointer hover:bg-gray-200 text-sm ${idx === cSession.currentIndex ? 'bg-white border-l-4 border-lion-gold font-bold shadow-sm' : 'text-gray-600'}">
                                    ${idx+1}. ${s.title}
                                </div>
                            `).join('');

                            const mediaEmbed = currentSlide.mediaUrl ? `
                                <div class="mt-6 mb-6">
                                    <img src="${currentSlide.mediaUrl}" class="max-h-64 mx-auto rounded shadow" alt="Slide Media" onerror="this.style.display='none'">
                                </div>` : '';

                            const isLastSlide = cSession.currentIndex === cSession.slides.length - 1;
                            const nextBtnText = isLastSlide ? "Finish Course" : "Next Slide";
                            const nextAction = isLastSlide ? "window.app.finishCourse()" : "window.app.nextSlide()";
                            
                            let linkedAssessmentBtn = '';
                            if(cSession.linkedQuizId) {
                                linkedAssessmentBtn = `<button onclick="window.app.startQuiz(${cSession.linkedQuizId})" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm"><i class="fas fa-clipboard-check mr-2"></i> Take Assessment</button>`;
                            }

                            container.innerHTML = `
                                <div class="fixed inset-0 bg-white z-50 flex flex-col md:flex-row fade-in">
                                    <!-- Sidebar -->
                                    <div class="w-full md:w-64 bg-gray-100 border-r border-gray-200 flex flex-col h-full">
                                        <div class="p-4 bg-gray-800 text-white font-bold flex justify-between items-center">
                                            <span>Contents</span>
                                            <button onclick="window.app.render('dashboard')" class="text-xs text-gray-400 hover:text-white">Exit</button>
                                        </div>
                                        <div class="flex-grow overflow-y-auto">
                                            ${contentsList}
                                        </div>
                                        <div class="p-4 border-t border-gray-200">
                                            ${linkedAssessmentBtn}
                                        </div>
                                    </div>

                                    <!-- Main Slide Area -->
                                    <div class="flex-1 flex flex-col h-full bg-gray-50">
                                        <div class="h-2 bg-gray-200 w-full"><div class="h-full bg-green-500 transition-all duration-300" style="width: ${progress}%"></div></div>
                                        <div class="flex-grow p-8 overflow-y-auto flex items-center justify-center">
                                            <div class="max-w-3xl w-full bg-white p-10 rounded-xl shadow-xl min-h-[50vh]">
                                                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">${currentSlide.title}</h2>
                                                ${mediaEmbed}
                                                <div class="prose max-w-none text-gray-700 leading-relaxed text-lg whitespace-pre-wrap">${currentSlide.content}</div>
                                            </div>
                                        </div>
                                        <div class="p-4 bg-white border-t border-gray-200 flex justify-between items-center">
                                            <button onclick="window.app.prevSlide()" class="px-6 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold ${cSession.currentIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${cSession.currentIndex === 0 ? 'disabled' : ''}>Previous</button>
                                            <div class="text-gray-500 font-mono">Slide ${cSession.currentIndex + 1} / ${cSession.slides.length}</div>
                                            <button onclick="${nextAction}" class="px-6 py-2 rounded bg-lion-gold hover:bg-yellow-600 text-white font-bold shadow">${nextBtnText}</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            break;

                        case 'quiz':
                            const session = App.currentQuizSession;
                            if (!session) return App.render('dashboard');
                            
                            const introHtml = session.introText ? `<div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-4 mb-6 rounded text-sm leading-relaxed">${session.introText.replace(/\n/g, '<br>')}</div>` : '';
                            const linkHtml = session.materialLink ? `<div class="mb-6 text-center"><a href="${session.materialLink}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-4 py-2 bg-lion-gold text-white rounded hover:bg-yellow-600 transition shadow"><i class="fas fa-book-open mr-2"></i> View Course Material</a></div>` : '';
                            
                            let linkedCourseBtn = '';
                            if(session.linkedCourseId) {
                                linkedCourseBtn = `<div class="mb-6 text-center"><button onclick="window.app.startCourse(${session.linkedCourseId})" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition shadow"><i class="fas fa-play mr-2"></i> Review Course Slides</button></div>`;
                            }

                            let qHtml = session.questions.map((q, idx) => `
                                <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200"><p class="font-semibold text-lg text-gray-800 mb-4"><span class="text-lion-gold font-bold mr-2">Q${idx+1}.</span> ${q.q}</p>
                                <div class="space-y-3">${q.options.map((opt, optIdx) => `<label class="flex items-center p-3 bg-white border border-gray-300 rounded cursor-pointer hover:border-lion-gold hover:bg-yellow-50 transition"><input type="radio" name="q_${idx}" value="${optIdx}" class="w-4 h-4 text-lion-gold focus:ring-lion-gold border-gray-300" required><span class="ml-3 text-gray-700">${opt}</span></label>`).join('')}</div></div>`).join('');
                            
                            container.innerHTML = `
                                <div class="max-w-3xl mx-auto fade-in bg-white p-8 rounded-xl shadow-lg">
                                    <div class="flex justify-between items-center mb-6 pb-4 border-b"><div><h2 class="text-2xl font-bold">${session.title}</h2><p class="text-xs text-gray-500 mt-1">Pass Mark: ${session.passMark} correct</p></div><button onclick="window.app.render('dashboard')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i> Cancel</button></div>
                                    ${linkedCourseBtn}
                                    ${introHtml}
                                    ${linkHtml}
                                    <form id="quizForm" onsubmit="event.preventDefault(); window.app.submitQuiz()">${qHtml}<div class="mt-8 pt-4 border-t border-gray-100 flex justify-end"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow transition text-lg">Submit Assessment</button></div></form>
                                </div>`;
                            break;

                        case 'quizResults':
                            // ... (quizResults code unchanged)
                            const rId = data;
                            const res = await DB.getById("results", rId);
                            if (!res) { App.showModal("Error", "Result not found", false); return App.render('dashboard'); }
                            
                            let resHtml = '';
                            if (res.snapshot) {
                                resHtml = res.snapshot.map((item, idx) => {
                                    const isCorrect = item.userAns === item.ans;
                                    const icon = isCorrect ? '<i class="fas fa-check-circle text-green-600"></i>' : '<i class="fas fa-times-circle text-red-600"></i>';
                                    const optsFb = item.options.map((opt, optIdx) => {
                                        let style = "p-2 rounded border border-gray-200 bg-white text-gray-500";
                                        let iconHTML = "";
                                        if (optIdx === item.ans) { style = "p-2 rounded border border-green-500 bg-green-100 text-green-800 font-bold"; iconHTML = '<i class="fas fa-check float-right mt-1"></i>'; }
                                        else if (optIdx === item.userAns && !isCorrect) { style = "p-2 rounded border border-red-500 bg-red-100 text-red-800 font-bold"; iconHTML = '<i class="fas fa-times float-right mt-1"></i>'; }
                                        return `<div class="${style} text-sm mb-1">${opt} ${iconHTML}</div>`;
                                    }).join('');
                                    return `<div class="mb-6 p-5 rounded-lg border-l-4 shadow-sm bg-white ${isCorrect ? 'border-green-500' : 'border-red-500'}"><div class="flex justify-between items-start mb-3"><h4 class="font-bold text-gray-800">Question ${idx+1}</h4><span class="text-xl">${icon}</span></div><p class="text-gray-700 mb-3">${item.q}</p><div class="space-y-1 mb-4">${optsFb}</div><div class="bg-gray-100 p-3 rounded text-sm text-gray-600 border-l-2 border-gray-400"><strong>Explanation:</strong> ${item.explain || "N/A"}</div></div>`;
                                }).join('');
                            } else { resHtml = "<p>Legacy data unavailable.</p>"; }

                            const backAct = App.currentUser.role === 'admin' ? "window.app.render('adminDashboard')" : "window.app.render('dashboard')";
                            container.innerHTML = `
                                <div class="max-w-3xl mx-auto fade-in">
                                    <div class="bg-white p-8 rounded-xl shadow-lg mb-8 text-center border-t-4 ${res.passed ? 'border-green-500' : 'border-red-500'}"><h2 class="text-3xl font-bold mb-2">${res.passed ? 'PASSED' : 'FAILED'}</h2><div class="text-5xl font-bold my-4 ${res.passed ? 'text-green-600' : 'text-red-600'}">${res.score}%</div><p class="text-gray-500 mb-6">User: ${res.userName} | Date: ${new Date(res.date).toLocaleDateString()}</p><button onclick="${backAct}" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-900 transition">Back</button></div>
                                    <div class="space-y-6">${resHtml}</div>
                                </div>`;
                            break;

                        case 'adminDashboard':
                            // ... (adminDashboard code unchanged)
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const aUsers = await DB.getAll("users");
                            const aResults = await DB.getAll("results");
                            const aQuizzes = await DB.getAll("quizzes");
                            const aCourses = await DB.getAll("courses"); // Fetch courses
                            
                            // Storage Calculation
                            const storageBytes = await DB.getStorageEstimate();
                            const storageMB = (storageBytes / (1024 * 1024)).toFixed(2);
                            const limitMB = 1000; // 1GB roughly
                            const percentage = Math.min(((storageMB / limitMB) * 100), 100).toFixed(2);
                            const color = percentage > 80 ? 'bg-red-500' : (percentage > 50 ? 'bg-yellow-500' : 'bg-green-500');

                            const resRows = aResults.filter(r => r.type !== 'course').slice().reverse().map(r => `
                                <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="window.app.viewResult('${r.resultId}')">
                                    <td class="p-4 font-medium">${r.userName}</td>
                                    <td class="p-4 text-gray-600">${r.quizTitle}</td>
                                    <td class="p-4 font-bold ${r.passed ? 'text-green-600' : 'text-red-500'}">${r.score}%</td>
                                    <td class="p-4 text-sm text-gray-500">${new Date(r.date).toLocaleDateString()}</td>
                                </tr>`).join('');

                            const showArchived = App.viewArchived;
                            const displayedUsers = aUsers.filter(u => !!u.archived === showArchived);

                            const uRows = displayedUsers.map(u => {
                                // Calculate Quiz Status
                                const quizAssigns = (u.assigned || []).map(qId => {
                                    const q = aQuizzes.find(x => x.id === qId);
                                    if (!q) return '';
                                    const uRes = aResults.filter(r => r.userId === u.id && r.quizId === qId && r.type !== 'course');
                                    const last = uRes.length ? uRes[uRes.length-1] : null;
                                    if(last) {
                                        const col = last.passed ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                                        return `<span onclick="event.stopPropagation(); window.app.viewResult('${last.resultId}')" class="cursor-pointer inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${col} mr-1 mb-1">${q.title.substring(0,10)}...: ${last.score}%</span>`;
                                    }
                                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200 mr-1 mb-1">${q.title.substring(0,10)}...</span>`;
                                }).join('');

                                // Calculate Course Status
                                const courseAssigns = (u.assignedCourses || []).map(cId => {
                                    const c = aCourses.find(x => x.id === cId);
                                    if (!c) return '';
                                    const completed = aResults.some(r => r.userId === u.id && r.courseId === cId && r.type === 'course');
                                    const col = completed ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-gray-100 text-gray-800 border-gray-200';
                                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${col} mr-1 mb-1"><i class="fas fa-book mr-1"></i>${c.title.substring(0,10)}</span>`;
                                }).join('');
                                
                                const archiveBtn = showArchived 
                                    ? `<button type="button" onclick="window.app.restoreUser('${u.id}')" class="text-green-600 hover:text-green-800 text-sm ml-3 font-semibold"><i class="fas fa-trash-restore"></i> Restore</button>`
                                    : `<button type="button" onclick="window.app.archiveUser('${u.id}')" class="text-orange-500 hover:text-orange-700 text-sm ml-3 font-semibold"><i class="fas fa-archive"></i> Archive</button>`;

                                return `<tr class="border-b hover:bg-gray-50">
                                    <td class="p-4 font-bold text-gray-800">${u.name}</td>
                                    <td class="p-4 text-gray-600 font-mono text-sm">${u.username}</td>
                                    <td class="p-4">
                                        <div class="mb-1 text-xs text-gray-400">Assessments:</div>
                                        <div class="flex flex-wrap mb-2">${quizAssigns || '-'}</div>
                                        <div class="mb-1 text-xs text-gray-400">Courses:</div>
                                        <div class="flex flex-wrap">${courseAssigns || '-'}</div>
                                    </td>
                                    <td class="p-4 text-right">
                                        <button onclick="window.app.editUser('${u.id}')" class="text-sm bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-100">Manage</button>
                                        ${archiveBtn}
                                    </td>
                                </tr>`;
                            }).join('');

                            const toggleBtnText = showArchived ? "Show Active Users" : "Show Archived Users";
                            const toggleBtnColor = showArchived ? "bg-green-600 hover:bg-green-700" : "bg-gray-500 hover:bg-gray-600";

                            container.innerHTML = `
                                <div class="fade-in space-y-8">
                                    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-lg shadow-sm">
                                        <div><h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2><p class="text-gray-500">Cloud Database Active</p></div>
                                        <div class="mt-4 md:mt-0 flex flex-col md:flex-row gap-3"><button onclick="window.app.render('dashboard')" class="bg-white border border-gray-300 px-4 py-2 rounded">My View</button><button onclick="window.app.render('manageCourses')" class="bg-white border border-gray-300 px-4 py-2 rounded">Manage Courses</button><button onclick="window.app.render('manageQuizzes')" class="bg-white border border-gray-300 px-4 py-2 rounded">Manage Assessments</button><button onclick="window.app.startCreateUser()" class="bg-lion-gold text-white px-6 py-2 rounded font-bold">+ Create User</button></div>
                                    </div>
                                    
                                    <!-- STORAGE METER -->
                                    <div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-between">
                                        <div class="flex items-center text-sm font-bold text-gray-700"><i class="fas fa-database mr-2 text-lion-gold"></i> Database Storage</div>
                                        <div class="flex-grow mx-4">
                                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                <div class="${color} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 font-mono">${storageMB}MB / 1GB (${percentage}%)</div>
                                    </div>

                                    <div class="grid lg:grid-cols-3 gap-8">
                                        <div class="lg:col-span-2 bg-white rounded-lg shadow overflow-hidden">
                                            <div class="bg-gray-50 px-6 py-4 border-b font-bold text-gray-700 flex justify-between items-center">
                                                <span>${showArchived ? 'Archived Users' : 'Active User Database'}</span>
                                                <button onclick="window.app.toggleArchivedView()" class="text-xs text-white px-3 py-1 rounded ${toggleBtnColor}">${toggleBtnText}</button>
                                            </div>
                                            <div class="overflow-x-auto max-h-[500px] overflow-y-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10"><tr><th class="p-4">Name</th><th class="p-4">User</th><th class="p-4">Status</th><th class="p-4 text-right">Action</th></tr></thead><tbody>${uRows || '<tr><td colspan="4" class="p-4 text-center text-gray-500">No users found in this view.</td></tr>'}</tbody></table></div></div>
                                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b font-bold text-gray-700">Quiz History</div><div class="overflow-x-auto max-h-[500px] overflow-y-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10"><tr><th class="p-4">User</th><th class="p-4">Quiz</th><th class="p-4">Score</th></tr></thead><tbody>${resRows}</tbody></table></div></div>
                                    </div>
                                </div>`;
                            break;

                        case 'manageQuizzes':
                             if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const mQuizzes = await DB.getAll("quizzes");
                            const mQUsers = await DB.getAll("users");
                            const qRows = mQuizzes.map(q => {
                                const count = mQUsers.filter(u => (u.assigned || []).includes(q.id)).length;
                                return `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-gray-800">${q.title}</td><td class="p-4">${q.questions.length} Qs</td><td class="p-4">${count} Users</td><td class="p-4 text-right"><button onclick="window.app.editQuiz(${q.id})" class="text-blue-600 mr-4">Edit</button><button onclick="window.app.deleteQuiz(${q.id})" class="text-red-500">Delete</button></td></tr>`;
                            }).join('');
                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Assessments</h2><div><button onclick="window.app.render('adminDashboard')" class="text-gray-500 mr-4">Back</button><button onclick="window.app.startCreateQuiz()" class="bg-lion-gold text-white px-6 py-2 rounded font-bold">+ New Assessment</button></div></div>
                                <div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="p-4">Title</th><th class="p-4">Bank</th><th class="p-4">Assigned</th><th class="p-4 text-right">Actions</th></tr></thead><tbody>${qRows || '<tr><td colspan="4" class="p-6 text-center">No assessments found.</td></tr>'}</tbody></table></div></div>`;
                            break;

                        case 'manageCourses':
                            // ... (manageCourses code unchanged)
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const mCourses = await DB.getAll("courses");
                            const mcUsers = await DB.getAll("users");
                            const cRows = mCourses.map(c => {
                                const count = mcUsers.filter(u => (u.assignedCourses || []).includes(c.id)).length;
                                return `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-gray-800">${c.title}</td><td class="p-4">${c.slides ? c.slides.length : 0} Slides</td><td class="p-4">${count} Users</td><td class="p-4 text-right"><button onclick="window.app.editCourse(${c.id})" class="text-blue-600 mr-4">Edit</button><button onclick="window.app.deleteCourse(${c.id})" class="text-red-500">Delete</button></td></tr>`;
                            }).join('');
                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Training Courses</h2><div><button onclick="window.app.render('adminDashboard')" class="text-gray-500 mr-4">Back</button><button onclick="window.app.startCreateCourse()" class="bg-lion-gold text-white px-6 py-2 rounded font-bold">+ New Course</button></div></div>
                                <div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="p-4">Title</th><th class="p-4">Content</th><th class="p-4">Assigned</th><th class="p-4 text-right">Actions</th></tr></thead><tbody>${cRows || '<tr><td colspan="4" class="p-6 text-center">No courses found.</td></tr>'}</tbody></table></div></div>`;
                            break;

                        case 'userForm':
                            // ... (userForm code unchanged)
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const isEdit = !!App.editingUser;
                            const u = App.editingUser || { name: '', username: '', pin: '', email: '', role: 'learner', assigned: [], assignedCourses: [] };
                            const formQuizzes = await DB.getAll("quizzes");
                            const formCourses = await DB.getAll("courses");
                            
                            const assignedTags = (u.assigned || []).map(id => {
                                const q = formQuizzes.find(x => x.id === id);
                                return q ? `<div class="bg-yellow-50 border border-yellow-200 text-yellow-800 rounded px-3 py-1 flex items-center gap-2" data-id="${id}" data-type="quiz"><span class="text-sm font-medium"><i class="fas fa-clipboard-check mr-1"></i> ${q.title}</span><button type="button" onclick="this.parentElement.remove()" class="text-yellow-600 hover:text-yellow-800"><i class="fas fa-times"></i></button></div>` : '';
                            }).join('');
                            
                            const assignedCourseTags = (u.assignedCourses || []).map(id => {
                                const c = formCourses.find(x => x.id === id);
                                return c ? `<div class="bg-blue-50 border border-blue-200 text-blue-800 rounded px-3 py-1 flex items-center gap-2" data-id="${id}" data-type="course"><span class="text-sm font-medium"><i class="fas fa-book mr-1"></i> ${c.title}</span><button type="button" onclick="this.parentElement.remove()" class="text-blue-600 hover:text-blue-800"><i class="fas fa-times"></i></button></div>` : '';
                            }).join('');

                            const ddItems = formQuizzes.map(q => `<div onclick="window.app.addAssignment(${q.id}, 'quiz')" data-search="${q.title.toLowerCase()}" class="quiz-option p-3 hover:bg-gray-100 cursor-pointer border-b">${q.title}</div>`).join('');
                            const courseDDItems = formCourses.map(c => `<div onclick="window.app.addAssignment(${c.id}, 'course')" data-search="${c.title.toLowerCase()}" class="course-option p-3 hover:bg-gray-100 cursor-pointer border-b">${c.title}</div>`).join('');

                            const sendInviteBtn = isEdit 
                                ? `<button type="button" onclick="window.app.sendAssessmentInvite()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow transition mr-auto flex items-center"><i class="fas fa-envelope mr-2"></i> Send Email</button>`
                                : '';
                            
                            const deleteUserBtn = isEdit
                                ? `<button type="button" onclick="window.app.deleteUserAction('${u.id}')" class="text-red-500 hover:text-red-700 text-sm font-bold ml-4 border border-red-200 bg-red-50 px-3 py-2 rounded">Delete User</button>`
                                : '';

                            let historyHTML = '';
                            if (isEdit) {
                                const allResultsHist = await DB.getAll("results");
                                const userHist = allResultsHist.filter(r => r.userId === u.id).sort((a,b) => new Date(b.date) - new Date(a.date));
                                const histRows = userHist.map(r => {
                                    if(r.type === 'course') {
                                        return `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-sm">${new Date(r.date).toLocaleString()}</td><td class="p-3 text-sm font-medium">${r.courseTitle}</td><td class="p-3 text-sm font-bold text-blue-600">Completed</td><td class="p-3 text-sm">-</td></tr>`;
                                    } else {
                                        return `<tr class="border-b hover:bg-gray-50"><td class="p-3 text-sm">${new Date(r.date).toLocaleString()}</td><td class="p-3 text-sm font-medium">${r.quizTitle}</td><td class="p-3 text-sm font-bold ${r.passed ? 'text-green-600' : 'text-red-600'}">${r.score}%</td><td class="p-3 text-sm"><button onclick="window.app.viewResult('${r.resultId}')" class="text-blue-600 hover:underline">View</button></td></tr>`;
                                    }
                                }).join('');
                                
                                historyHTML = `<div class="mt-8 border-t pt-6"><h3 class="font-bold text-gray-800 mb-4">Activity History</h3><div class="bg-gray-50 rounded border border-gray-200 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-100 text-xs text-gray-600 uppercase border-b"><tr><th class="p-3">Date</th><th class="p-3">Item</th><th class="p-3">Status</th><th class="p-3">Report</th></tr></thead><tbody>${histRows || '<tr><td colspan="4" class="p-4 text-center text-gray-500 text-sm">No activity recorded.</td></tr>'}</tbody></table></div></div>`;
                            }

                            container.innerHTML = `
                                <div class="max-w-2xl mx-auto mt-10 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${isEdit ? 'Manage User' : 'Create New User'}</h2>
                                    <form onsubmit="window.app.handleSaveUser(event)">
                                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Name</label><input type="text" id="formName" value="${safe(u.name)}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Email Address</label><input type="email" id="formEmail" value="${safe(u.email)}" placeholder="user@company.com" class="w-full p-3 border border-gray-300 rounded"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Username</label><input type="text" id="formUsername" value="${safe(u.username)}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">PIN</label><input type="text" id="formPin" value="${safe(u.pin)}" maxlength="4" class="w-full p-3 border border-gray-300 rounded text-center"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Role</label><select id="formRole" class="w-full p-3 border border-gray-300 rounded"><option value="learner" ${u.role === 'learner'?'selected':''}>Learner</option><option value="admin" ${u.role === 'admin'?'selected':''}>Admin</option></select></div>
                                        </div>
                                        
                                        <div class="mb-6 border-t pt-4">
                                            <label class="block text-gray-700 text-sm font-bold mb-3">Assignments</label>
                                            <div id="assigned-container" class="flex flex-wrap gap-2 mb-4 min-h-[40px] p-2 bg-gray-50 rounded border border-gray-200">
                                                ${assignedTags}
                                                ${assignedCourseTags}
                                            </div>
                                            
                                            <!-- Assessment Selector -->
                                            <div class="flex gap-2 relative mb-2" id="quizInputContainer">
                                                <input type="text" id="quizInput" oninput="window.app.filterQuizzes()" onfocus="window.app.showQuizDropdown()" class="w-full p-3 border border-gray-300 rounded" placeholder="Add Assessment...">
                                                <div id="quizDropdown" class="hidden absolute z-20 w-full bg-white border border-gray-300 mt-1 max-h-60 overflow-y-auto shadow-xl rounded-md top-12 custom-dropdown">${ddItems}</div>
                                            </div>
                                            
                                            <!-- Course Selector -->
                                            <div class="flex gap-2 relative" id="courseInputContainer">
                                                <input type="text" id="courseInput" oninput="window.app.filterCourses()" onfocus="window.app.showCourseDropdown()" class="w-full p-3 border border-gray-300 rounded" placeholder="Add Training Course...">
                                                <div id="courseDropdown" class="hidden absolute z-20 w-full bg-white border border-gray-300 mt-1 max-h-60 overflow-y-auto shadow-xl rounded-md top-12 custom-dropdown">${courseDDItems}</div>
                                            </div>
                                        </div>

                                        <div class="flex justify-between items-center pt-4 border-t">
                                            <div class="flex items-center">
                                                ${sendInviteBtn}
                                                ${deleteUserBtn}
                                            </div>
                                            <div class="flex ml-auto gap-3">
                                                <button type="button" onclick="window.app.render('adminDashboard')" class="text-gray-500">Cancel</button>
                                                <button type="submit" class="bg-lion-gold text-white font-bold py-2 px-8 rounded shadow">Save</button>
                                            </div>
                                        </div>
                                    </form>
                                    ${historyHTML}
                                </div>`;
                            break;

                        case 'quizForm':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const isEditQ = !!App.editingQuiz;
                            const q = App.editingQuiz || { title: '', desc: '', questions: [], displayCount: 5, passMark: 4, introText: '', materialLink: '', linkedCourseId: '' };
                            if (!isEditQ && q.questions.length === 0) q.questions.push({ q: '', options: ['', '', '', ''], ans: 0, explain: '' });

                            const coursesForLink = await DB.getAll("courses");
                            const courseOptions = coursesForLink.map(c => `<option value="${c.id}" ${q.linkedCourseId == c.id ? 'selected' : ''}>${c.title}</option>`).join('');

                            const qBlocks = q.questions.map((quest, idx) => {
                                const opts = quest.options; while(opts.length < 4) opts.push('');
                                return `
                                    <div class="question-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative">
                                        <div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.question-block').remove(); window.app.updateQuizCounts();"><i class="fas fa-trash"></i></div>
                                        <div class="mb-4"><label class="block text-sm font-bold mb-2">Question ${idx+1}</label><input type="text" class="q-text w-full p-3 border border-gray-300 rounded" value="${safe(quest.q)}" required></div>
                                        <div class="grid md:grid-cols-2 gap-4 mb-4">${opts.map((opt, i) => `<div class="flex items-center"><input type="radio" name="ans_radio_${idx}" value="${i}" ${quest.ans===i?'checked':''} class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" value="${safe(opt)}" required></div>`).join('')}</div>
                                        <div><label class="block text-xs font-bold mb-1">Explanation</label><textarea class="q-explain w-full p-2 border border-gray-300 rounded text-sm">${quest.explain||''}</textarea></div>
                                    </div>`;
                            }).join('');

                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto mt-6 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${isEditQ ? 'Edit Assessment' : 'Create New Assessment'}</h2>
                                    <form onsubmit="window.app.handleSaveQuiz(event)">
                                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2">Title</label><input type="text" id="quizTitle" value="${safe(q.title)}" required class="w-full p-3 border border-gray-300 rounded text-lg font-bold"></div>
                                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2">Description</label><input type="text" id="quizDesc" value="${safe(q.desc)}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                        </div>
                                        
                                        <div class="bg-blue-50 border border-blue-200 p-4 rounded mb-8">
                                            <div class="mb-6">
                                                <label class="block text-sm font-bold mb-2 text-blue-900">Linked Training Course</label>
                                                <select id="quizLinkedCourse" class="w-full p-3 border border-gray-300 rounded">
                                                    <option value="">-- None --</option>
                                                    ${courseOptions}
                                                </select>
                                                <p class="text-xs text-gray-500 mt-1">Learners can jump to this course from the assessment.</p>
                                            </div>
                                            <div class="mb-6">
                                                <label class="block text-sm font-bold mb-2 text-blue-900">Introduction / Instructions</label>
                                                <textarea id="quizIntroText" class="w-full p-3 border border-gray-300 rounded text-sm" rows="3" placeholder="Instructions shown before questions...">${q.introText || ''}</textarea>
                                            </div>
                                            <div class="mb-6">
                                                <label class="block text-sm font-bold mb-2 text-blue-900">Course Material Link</label>
                                                <input type="url" id="quizMaterialLink" value="${safe(q.materialLink)}" class="w-full p-3 border border-gray-300 rounded" placeholder="https://example.com/document.pdf">
                                            </div>
                                            <div class="grid md:grid-cols-2 gap-6">
                                                <div><label class="block text-sm font-bold mb-1 text-blue-900">Display Count</label><input type="number" id="quizDisplayCount" value="${q.displayCount||q.questions.length}" min="1" class="w-full p-2 border border-gray-300 rounded"></div>
                                                <div><label class="block text-sm font-bold mb-1 text-blue-900">Pass Mark</label><input type="number" id="quizPassMark" value="${q.passMark||1}" min="1" class="w-full p-2 border border-gray-300 rounded"></div>
                                            </div>
                                        </div>

                                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-1">Question Bank <span id="qBankCount" class="text-sm font-normal text-gray-500">(${q.questions.length})</span></h3>
                                        <div id="questions-container">${qBlocks}</div>
                                        <div class="mb-8"><button type="button" onclick="window.app.addQuestionHTML()" class="text-lion-gold border border-lion-gold rounded px-4 py-2 text-sm w-full">+ Add Question</button></div>
                                        <div class="flex justify-between pt-4 border-t"><button type="button" onclick="window.app.render('manageQuizzes')" class="text-gray-500">Cancel</button><button type="submit" class="bg-lion-gold text-white font-bold py-3 px-8 rounded shadow">Save Assessment</button></div>
                                    </form>
                                </div>`;
                            break;

                        case 'courseForm':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const isEditC = !!App.editingCourse;
                            const c = App.editingCourse || { title: '', desc: '', slides: [], linkedQuizId: '' };
                            if (!isEditC && c.slides.length === 0) c.slides.push({ title: '', content: '', mediaUrl: '' });
                            
                            const quizzesForLink = await DB.getAll("quizzes");
                            const quizOptions = quizzesForLink.map(q => `<option value="${q.id}" ${c.linkedQuizId == q.id ? 'selected' : ''}>${q.title}</option>`).join('');
                            
                            const toolbarHTML = `
                                <div class="flex gap-1 mb-2 bg-gray-100 p-1 rounded border border-gray-200 flex-wrap">
                                    <button type="button" onclick="window.app.insertFormat(this, 'bold')" class="p-1 hover:bg-gray-200 rounded" title="Bold"><i class="fas fa-bold"></i></button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'italic')" class="p-1 hover:bg-gray-200 rounded" title="Italic"><i class="fas fa-italic"></i></button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'underline')" class="p-1 hover:bg-gray-200 rounded" title="Underline"><i class="fas fa-underline"></i></button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'list')" class="p-1 hover:bg-gray-200 rounded" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                    <div class="border-l border-gray-300 mx-1"></div>
                                    <button type="button" onclick="window.app.insertFormat(this, '‚úÖ')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚úÖ</button>
                                    <button type="button" onclick="window.app.insertFormat(this, '‚ö†Ô∏è')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚ö†Ô∏è</button>
                                    <button type="button" onclick="window.app.insertFormat(this, '‚≠ê')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚≠ê</button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'üëç')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üëç</button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'üî¥')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üî¥</button>
                                    <button type="button" onclick="window.app.insertFormat(this, 'üü¢')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üü¢</button>
                                </div>`;

                            const sBlocks = c.slides.map((slide, idx) => `
                                <div class="slide-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative">
                                    <div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.slide-block').remove();" title="Remove Slide"><i class="fas fa-trash"></i></div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">Slide ${idx+1} Title</label>
                                        <input type="text" class="s-title w-full p-3 border border-gray-300 rounded" value="${safe(slide.title)}" required>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold mb-2">Content (Text)</label>
                                        ${toolbarHTML}
                                        <textarea class="s-content w-full p-3 border border-gray-300 rounded h-32" required>${slide.content}</textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold mb-2">Media URL (Optional Image/Video)</label>
                                        <div class="flex gap-2">
                                            <input type="text" class="s-media w-full p-3 border border-gray-300 rounded" value="${safe(slide.mediaUrl)}" placeholder="https://...">
                                            <button type="button" onclick="window.app.handleImageUpload(this)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded shadow" title="Upload Image"><i class="fas fa-cloud-upload-alt"></i></button>
                                        </div>
                                    </div>
                                </div>`).join('');

                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto mt-6 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-blue-500">
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${isEditC ? 'Edit Course' : 'Create New Course'}</h2>
                                    <form onsubmit="window.app.handleSaveCourse(event)">
                                        <div class="mb-6"><label class="block text-sm font-bold mb-2">Course Title</label><input type="text" id="courseTitle" value="${safe(c.title)}" required class="w-full p-3 border border-gray-300 rounded text-lg font-bold"></div>
                                        <div class="mb-6"><label class="block text-sm font-bold mb-2">Description</label><input type="text" id="courseDesc" value="${safe(c.desc)}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                        
                                        <div class="mb-8 p-4 bg-yellow-50 border border-yellow-200 rounded">
                                            <label class="block text-sm font-bold mb-2 text-yellow-900">Linked Assessment</label>
                                            <select id="courseLinkedQuiz" class="w-full p-3 border border-gray-300 rounded">
                                                <option value="">-- None --</option>
                                                ${quizOptions}
                                            </select>
                                            <p class="text-xs text-gray-500 mt-1">If selected, this assessment will be automatically assigned when you assign this course.</p>
                                        </div>

                                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-1">Slides</h3>
                                        <div id="slides-container">${sBlocks}</div>
                                        <div class="mb-8"><button type="button" onclick="window.app.addSlideHTML()" class="text-blue-600 border border-blue-600 rounded px-4 py-2 text-sm w-full">+ Add Slide</button></div>
                                        
                                        <div class="flex justify-between pt-4 border-t"><button type="button" onclick="window.app.render('manageCourses')" class="text-gray-500">Cancel</button><button type="submit" class="bg-blue-600 text-white font-bold py-3 px-8 rounded shadow">Save Course</button></div>
                                    </form>
                                </div>`;
                            break;
                    }
                } catch (err) {
                    console.error("Render Error:", err);
                    container.innerHTML = `<div class="p-10 text-center text-red-500">Error loading content: ${err.message}</div>`;
                } finally {
                    App.showLoader(false);
                }
            },

            // --- ACTIONS (Async) ---
            handleLogin: async () => {
                App.showLoader(true);
                const uInput = document.getElementById('loginUsername').value.trim().toLowerCase();
                const pInput = document.getElementById('loginPin').value.trim();
                
                const q = query(collection(db, "users"), where("username", "==", uInput), where("pin", "==", pInput));
                const snap = await getDocs(q);
                
                App.showLoader(false);
                if (!snap.empty) {
                    const userData = snap.docs[0].data();
                    if(userData.archived) {
                        App.showModal('Access Denied', 'This account has been archived. Please contact an administrator.', false);
                        return;
                    }
                    App.currentUser = userData;
                    App.render(App.currentUser.role === 'admin' ? 'adminDashboard' : 'dashboard');
                } else {
                    App.showModal('Error', 'Invalid Login. Check Username and PIN.', false);
                }
            },

            logout: () => { App.currentUser = null; App.currentQuizSession = null; App.render('login'); },

            startCreateUser: () => { App.editingUser = null; App.render('userForm'); },
            
            editUser: async (id) => {
                const user = await DB.getById("users", id);
                if(user) { App.editingUser = user; App.render('userForm'); }
            },

            toggleArchivedView: () => {
                App.viewArchived = !App.viewArchived;
                App.render('adminDashboard');
            },

            archiveUser: (id) => {
                App.showModal(
                    "Archive User?",
                    "Are you sure you want to archive this user? They will not be able to login.",
                    true,
                    async () => {
                        try {
                            App.showLoader(true);
                            const user = await DB.getById("users", id);
                            if(user) {
                                user.archived = true;
                                await DB.save("users", user);
                            }
                            App.showLoader(false);
                            App.render('adminDashboard');
                        } catch(e) {
                            console.error(e);
                            App.showModal("Error", "Error archiving user: " + e.message, false);
                            App.showLoader(false);
                        }
                    }
                );
            },

            restoreUser: (id) => {
                App.showModal(
                    "Restore User?",
                    "Are you sure you want to restore this user?",
                    true,
                    async () => {
                        try {
                            App.showLoader(true);
                            const user = await DB.getById("users", id);
                            if(user) {
                                user.archived = false;
                                await DB.save("users", user);
                            }
                            App.showLoader(false);
                            App.render('adminDashboard');
                        } catch(e) {
                            console.error(e);
                            App.showModal("Error", "Error restoring user: " + e.message, false);
                            App.showLoader(false);
                        }
                    }
                );
            },

            deleteUserAction: (id) => {
                App.showModal(
                    "Delete User?",
                    "PERMANENT DELETE: This cannot be undone. Are you sure?",
                    true,
                    async () => {
                        try {
                            App.showLoader(true);
                            await DB.delete("users", id);
                            App.showLoader(false);
                            App.render('adminDashboard');
                        } catch(e) {
                            console.error(e);
                            App.showModal("Error", "Error deleting user: " + e.message, false);
                            App.showLoader(false);
                        }
                    }
                );
            },

            viewResult: (id) => { App.render('quizResults', id); },

            // Tag & Dropdown Logic
            showQuizDropdown: () => { document.getElementById('quizDropdown').classList.remove('hidden'); },
            showCourseDropdown: () => { document.getElementById('courseDropdown').classList.remove('hidden'); },
            
            filterQuizzes: () => {
                const val = document.getElementById('quizInput').value.toLowerCase();
                document.querySelectorAll('.quiz-option').forEach(el => {
                    el.classList.toggle('hidden', !el.dataset.search.includes(val));
                });
                document.getElementById('quizDropdown').classList.remove('hidden');
            },

            filterCourses: () => {
                const val = document.getElementById('courseInput').value.toLowerCase();
                document.querySelectorAll('.course-option').forEach(el => {
                    el.classList.toggle('hidden', !el.dataset.search.includes(val));
                });
                document.getElementById('courseDropdown').classList.remove('hidden');
            },

            addAssignment: async (id = null, type = 'quiz') => {
                App.showLoader(true);
                let item = null;
                
                if (type === 'quiz') {
                    const all = await DB.getAll("quizzes");
                    item = id ? all.find(x => x.id === id) : null;
                } else {
                    const all = await DB.getAll("courses");
                    item = id ? all.find(x => x.id === id) : null;
                }
                
                App.showLoader(false);
                
                if(!item) return;

                const container = document.getElementById('assigned-container');
                // Check dupes
                if(container.querySelector(`[data-id="${item.id}"][data-type="${type}"]`)) {
                    document.getElementById(type === 'quiz' ? 'quizInput' : 'courseInput').value = '';
                    document.getElementById(type === 'quiz' ? 'quizDropdown' : 'courseDropdown').classList.add('hidden');
                    return;
                }
                
                // AUTO-ASSIGN LOGIC (Implicit assignment when adding a course)
                if (type === 'course' && item.linkedQuizId) {
                   const quizContainer = document.getElementById('assigned-container');
                   if(!quizContainer.querySelector(`[data-id="${item.linkedQuizId}"][data-type="quiz"]`)) {
                        // Recursively add the quiz assignment
                        await App.addAssignment(parseInt(item.linkedQuizId), 'quiz');
                   }
                }

                const tag = document.createElement('div');
                const colorClass = type === 'quiz' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' : 'bg-blue-50 border-blue-200 text-blue-800';
                const icon = type === 'quiz' ? 'fa-clipboard-check' : 'fa-book';
                
                tag.className = `${colorClass} border rounded px-3 py-1 flex items-center gap-2`;
                tag.dataset.id = item.id;
                tag.dataset.type = type;
                tag.innerHTML = `<span class="text-sm font-medium"><i class="fas ${icon} mr-1"></i> ${item.title}</span><button type="button" onclick="this.parentElement.remove()" class="hover:opacity-75"><i class="fas fa-times"></i></button>`;
                container.appendChild(tag);
                
                const inputId = type === 'quiz' ? 'quizInput' : 'courseInput';
                const ddId = type === 'quiz' ? 'quizDropdown' : 'courseDropdown';
                document.getElementById(inputId).value = '';
                document.getElementById(ddId).classList.add('hidden');
            },

            handleSaveUser: async (e) => {
                e.preventDefault();
                App.showLoader(true);
                const name = document.getElementById('formName').value.trim();
                const email = document.getElementById('formEmail').value.trim();
                const username = document.getElementById('formUsername').value.trim().toLowerCase(); 
                const pin = document.getElementById('formPin').value.trim();
                const role = document.getElementById('formRole').value;
                
                // Separate assignments
                const allTags = Array.from(document.querySelectorAll('#assigned-container > div'));
                const assigned = allTags.filter(t => t.dataset.type === 'quiz').map(d => parseInt(d.dataset.id));
                const assignedCourses = allTags.filter(t => t.dataset.type === 'course').map(d => parseInt(d.dataset.id));

                if(App.editingUser) {
                    await DB.save("users", { ...App.editingUser, name, email, username, pin, role, assigned, assignedCourses });
                } else {
                    const q = query(collection(db, "users"), where("username", "==", username));
                    const snap = await getDocs(q);
                    if(!snap.empty) { App.showModal("Error", "Username taken", false); App.showLoader(false); return; }
                    await DB.save("users", { id: 'u' + Date.now(), name, email, username, pin, role, assigned, assignedCourses, archived: false });
                }
                App.showModal("Success", "User Saved!", false, () => {
                    App.editingUser = null;
                    App.render('adminDashboard');
                });
                App.showLoader(false);
            },

            // --- EMAIL FUNCTION ---
            sendAssessmentInvite: async () => {
                if(emailConfig.publicKey === "YOUR_PUBLIC_KEY") {
                    App.showModal("Configuration Error", "EmailJS is not configured. Please add your keys to the code.", false);
                    return;
                }
                
                const user = App.editingUser;
                const email = document.getElementById('formEmail').value.trim();
                if(!user || !email) {
                    App.showModal("Error", "Please ensure the user has a valid email address saved.", false);
                    return;
                }

                let appLink = APP_PUBLIC_URL;
                if (!appLink) {
                    if (window.location.href.startsWith("http") && !window.location.href.includes("localhost") && !window.location.href.startsWith("blob:")) {
                        appLink = window.location.href;
                    } else {
                        appLink = prompt("Please enter the public URL for your app:", "https://your-username.github.io/repository-name");
                        if (!appLink) return;
                    }
                }

                console.log(`Sending email to: ${email}`);

                App.showLoader(true);
                const allQ = await DB.getAll("quizzes");
                const assignedTitles = (user.assigned || []).map(id => {
                    const q = allQ.find(x => x.id === id);
                    return q ? `<li style="margin-bottom: 8px; font-weight: 600; color: #4a5568;">${q.title}</li>` : '';
                }).join('');

                const templateParams = {
                    to_name: user.name,
                    recipient_email: email, 
                    username: user.username,
                    pin: user.pin,
                    app_link: appLink,
                    assessments_list: `<ul style="padding-left: 20px; margin-top: 0;">${assignedTitles}</ul>`
                };

                try {
                    await emailjs.send(emailConfig.serviceID, emailConfig.templateID, templateParams);
                    App.showModal("Success", `Email successfully sent to ${email}`, false);
                } catch(err) {
                    console.error("EmailJS Error:", err);
                    App.showModal("Error", "Failed to send email. Check console for details.", false);
                } finally {
                    App.showLoader(false);
                }
            },

            startQuiz: async (id) => {
                App.showLoader(true);
                const quiz = await DB.getById("quizzes", id);
                App.showLoader(false);
                if(!quiz) return;

                const pool = [...quiz.questions];
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                const displayCount = quiz.displayCount || pool.length;
                const selected = pool.slice(0, displayCount);
                const passMark = quiz.passMark || Math.ceil(selected.length * 0.7);

                App.currentQuizSession = { 
                    quizId: quiz.id, 
                    title: quiz.title, 
                    questions: selected, 
                    passMark: passMark,
                    introText: quiz.introText,
                    materialLink: quiz.materialLink,
                    linkedCourseId: quiz.linkedCourseId // Passed for nav button
                };
                App.render('quiz');
            },

            submitQuiz: async () => {
                const session = App.currentQuizSession;
                const formData = new FormData(document.getElementById('quizForm'));
                let correctCount = 0;
                
                const snapshot = session.questions.map((q, idx) => {
                    const val = formData.get(`q_${idx}`);
                    const userAns = val ? parseInt(val) : -1;
                    if (userAns === q.ans) correctCount++;
                    return { ...q, userAns };
                });

                const total = session.questions.length;
                const score = Math.round((correctCount / total) * 100);
                const passed = correctCount >= session.passMark;
                
                const result = {
                    resultId: 'r' + Date.now(),
                    userId: App.currentUser.id,
                    userName: App.currentUser.name,
                    quizId: session.quizId,
                    quizTitle: session.title,
                    score, passed, snapshot,
                    date: new Date().toISOString()
                };

                App.showLoader(true);
                await DB.save("results", result);
                App.showLoader(false);
                App.render('quizResults', result.resultId);
            },

            // --- COURSE LOGIC ---
            switchTab: (tab) => {
                App.activeTab = tab;
                App.render('dashboard');
            },
            
            startCourse: async (id) => {
                App.showLoader(true);
                const course = await DB.getById("courses", id);
                App.showLoader(false);
                if(!course) return;
                
                App.currentCourseSession = { ...course, currentIndex: 0 };
                App.render('coursePlayer');
            },
            
            nextSlide: () => {
                if(App.currentCourseSession.currentIndex < App.currentCourseSession.slides.length - 1) {
                    App.currentCourseSession.currentIndex++;
                    App.render('coursePlayer');
                }
            },
            
            prevSlide: () => {
                if(App.currentCourseSession.currentIndex > 0) {
                    App.currentCourseSession.currentIndex--;
                    App.render('coursePlayer');
                }
            },
            
            jumpToSlide: (idx) => {
                App.currentCourseSession.currentIndex = idx;
                App.render('coursePlayer');
            },
            
            finishCourse: async () => {
                const c = App.currentCourseSession;
                // Save result
                const result = {
                    resultId: 'rc' + Date.now(),
                    userId: App.currentUser.id,
                    userName: App.currentUser.name,
                    courseId: c.id,
                    courseTitle: c.title,
                    type: 'course',
                    date: new Date().toISOString()
                };
                App.showLoader(true);
                await DB.save("results", result);
                App.showLoader(false);
                App.showModal("Course Completed", "Congratulations! Your progress has been saved.", false, () => {
                     App.render('dashboard');
                });
            },

            // --- COURSE MANAGEMENT ---
            startCreateCourse: () => { App.editingCourse = null; App.render('courseForm'); },
            editCourse: async (id) => {
                App.showLoader(true);
                const c = await DB.getById("courses", id);
                App.showLoader(false);
                if(c) { App.editingCourse = c; App.render('courseForm'); }
            },
            deleteCourse: (id) => {
                App.showModal("Delete Course?", "Are you sure?", true, async () => {
                    App.showLoader(true);
                    await DB.delete("courses", id);
                    const allUsers = await DB.getAll("users");
                    for(const u of allUsers) {
                        if((u.assignedCourses || []).includes(id)) {
                            u.assignedCourses = u.assignedCourses.filter(a => a !== id);
                            await DB.save("users", u);
                        }
                    }
                    App.showLoader(false);
                    App.render('manageCourses');
                });
            },
            
            addSlideHTML: () => {
                const container = document.getElementById('slides-container');
                const idx = container.children.length;
                const div = document.createElement('div');
                div.className = "slide-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative";
                
                const toolbarHTML = `
                    <div class="flex gap-1 mb-2 bg-gray-100 p-1 rounded border border-gray-200 flex-wrap">
                        <button type="button" onclick="window.app.insertFormat(this, 'bold')" class="p-1 hover:bg-gray-200 rounded" title="Bold"><i class="fas fa-bold"></i></button>
                        <button type="button" onclick="window.app.insertFormat(this, 'italic')" class="p-1 hover:bg-gray-200 rounded" title="Italic"><i class="fas fa-italic"></i></button>
                        <button type="button" onclick="window.app.insertFormat(this, 'underline')" class="p-1 hover:bg-gray-200 rounded" title="Underline"><i class="fas fa-underline"></i></button>
                        <button type="button" onclick="window.app.insertFormat(this, 'list')" class="p-1 hover:bg-gray-200 rounded" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                        <div class="border-l border-gray-300 mx-1"></div>
                        <button type="button" onclick="window.app.insertFormat(this, '‚úÖ')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚úÖ</button>
                        <button type="button" onclick="window.app.insertFormat(this, '‚ö†Ô∏è')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚ö†Ô∏è</button>
                        <button type="button" onclick="window.app.insertFormat(this, '‚≠ê')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">‚≠ê</button>
                        <button type="button" onclick="window.app.insertFormat(this, 'üëç')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üëç</button>
                        <button type="button" onclick="window.app.insertFormat(this, 'üî¥')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üî¥</button>
                        <button type="button" onclick="window.app.insertFormat(this, 'üü¢')" class="p-1 hover:bg-gray-200 rounded text-lg leading-none">üü¢</button>
                    </div>`;

                div.innerHTML = `
                    <div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.slide-block').remove();" title="Remove Slide"><i class="fas fa-trash"></i></div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Slide ${idx+1} Title</label>
                        <input type="text" class="s-title w-full p-3 border border-gray-300 rounded" placeholder="Slide Title">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2">Content</label>
                        ${toolbarHTML}
                        <textarea class="s-content w-full p-3 border border-gray-300 rounded h-32"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Media URL</label>
                        <div class="flex gap-2">
                            <input type="text" class="s-media w-full p-3 border border-gray-300 rounded" placeholder="Optional image/video URL">
                            <button type="button" onclick="window.app.handleImageUpload(this)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded shadow" title="Upload Image"><i class="fas fa-cloud-upload-alt"></i></button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            },
            
            handleSaveCourse: async (e) => {
                e.preventDefault();
                const title = document.getElementById('courseTitle').value.trim();
                const desc = document.getElementById('courseDesc').value.trim();
                const linkedQuizId = document.getElementById('courseLinkedQuiz').value; // Get Linked Quiz
                
                const sBlocks = document.querySelectorAll('.slide-block');
                const slides = Array.from(sBlocks).map(b => ({
                    title: b.querySelector('.s-title').value,
                    content: b.querySelector('.s-content').value,
                    mediaUrl: b.querySelector('.s-media').value
                }));
                
                const courseData = {
                    id: App.editingCourse ? App.editingCourse.id : Date.now(),
                    title, desc, slides, linkedQuizId
                };
                
                App.showLoader(true);
                await DB.save("courses", courseData);
                App.showLoader(false);
                App.editingCourse = null;
                App.showModal("Success", "Course Saved!", false, () => App.render('manageCourses'));
            },

            // --- IMAGE UPLOAD LOGIC (Base64) ---
            handleImageUpload: (btn) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Warn user about big files
                    if (file.size > 1024 * 1024) {
                        if(!confirm("This image is large (>1MB). It will be resized automatically to fit in the database. Continue?")) return;
                    }

                    App.showLoader(true);
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            // Resize logic using Canvas
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // Max dimensions
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 600;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Compress to JPEG 0.7 quality
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            
                            // Set value to input
                            const textInput = btn.previousElementSibling;
                            textInput.value = dataUrl;
                            
                            App.showLoader(false);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                };
                
                input.click();
            },

            // --- QUIZ MANAGEMENT ---
            startCreateQuiz: () => { App.editingQuiz = null; App.render('quizForm'); },
            editQuiz: async (id) => { 
                App.showLoader(true);
                const q = await DB.getById("quizzes", id);
                App.showLoader(false);
                if(q) { App.editingQuiz = q; App.render('quizForm'); }
            },
            deleteQuiz: (id) => {
                App.showModal(
                    "Delete Assessment?",
                    "Are you sure? This will remove it from all assigned users.",
                    true,
                    async () => {
                        try {
                            App.showLoader(true);
                            await DB.delete("quizzes", id);
                            
                            const allUsers = await DB.getAll("users");
                            for(const u of allUsers) {
                                if((u.assigned || []).includes(id)) {
                                    u.assigned = u.assigned.filter(a => a !== id);
                                    await DB.save("users", u);
                                }
                            }
                            App.showLoader(false);
                            App.render('manageQuizzes');
                        } catch(e) {
                            console.error(e);
                            App.showModal("Error", "Error deleting quiz: " + e.message, false);
                            App.showLoader(false);
                        }
                    }
                );
            },
            addQuestionHTML: () => {
                const container = document.getElementById('questions-container');
                const idx = container.children.length;
                const div = document.createElement('div');
                div.className = "question-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative fade-in";
                div.innerHTML = `<div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.question-block').remove(); window.app.updateQuizCounts();"><i class="fas fa-trash"></i></div>
                    <div class="mb-4"><label class="block text-sm font-bold mb-2">New Question</label><input type="text" class="q-text w-full p-3 border border-gray-300 rounded" placeholder="Question text..." required></div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4"><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="0" checked class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 1"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="1" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 2"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="2" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 3"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="3" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 4"></div></div>
                    <div><label class="block text-xs font-bold mb-1">Explanation</label><textarea class="q-explain w-full p-2 border border-gray-300 rounded text-sm"></textarea></div>`;
                container.appendChild(div);
                window.app.updateQuizCounts();
            },
            updateQuizCounts: () => { document.getElementById('qBankCount').textContent = `(${document.getElementById('questions-container').children.length})`; },
            handleSaveQuiz: async (e) => {
                e.preventDefault();
                const title = document.getElementById('quizTitle').value.trim();
                const desc = document.getElementById('quizDesc').value.trim();
                const introText = document.getElementById('quizIntroText').value.trim();
                const materialLink = document.getElementById('quizMaterialLink').value.trim();
                const linkedCourseId = document.getElementById('quizLinkedCourse').value; // Get Linked Course
                const displayCount = parseInt(document.getElementById('quizDisplayCount').value);
                const passMark = parseInt(document.getElementById('quizPassMark').value);
                
                const qBlocks = document.querySelectorAll('.question-block');
                const questions = Array.from(qBlocks).map(b => ({
                    q: b.querySelector('.q-text').value,
                    options: Array.from(b.querySelectorAll('.q-opt')).map(o => o.value),
                    ans: parseInt(b.querySelector('input[type=radio]:checked').value),
                    explain: b.querySelector('.q-explain').value
                }));

                const quizData = { 
                    id: App.editingQuiz ? App.editingQuiz.id : Date.now(),
                    title, desc, questions, displayCount, passMark,
                    introText, materialLink, linkedCourseId
                };

                App.showLoader(true);
                await DB.save("quizzes", quizData);
                App.showLoader(false);
                App.editingQuiz = null;
                App.showModal("Success", "Assessment Saved Successfully!", false, () => {
                    App.render('manageQuizzes');
                });
            }
        };

        // EXPOSE APP GLOBALLY
        window.app = App;

        // Start App
        // Use addEventListener to avoid overwriting other scripts and ensure DOM is ready
        window.addEventListener('load', () => window.app.init());
    </script>
</body>
</html>
