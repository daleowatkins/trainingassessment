<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Lion Training Assessment</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        :root {
            --lion-gold: #D4AF37;
            --lion-dark: #1a202c;
        }
        .text-lion-gold { color: var(--lion-gold); }
        .bg-lion-gold { background-color: var(--lion-gold); }
        .border-lion-gold { border-color: var(--lion-gold); }
        
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader { border-top-color: var(--lion-gold); -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Dropdown styles */
        .custom-dropdown {
            max-height: 0;
            transition: max-height 0.2s ease-out;
            overflow: hidden;
        }
        .custom-dropdown.open {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- NAVIGATION -->
    <nav class="bg-gray-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="window.app.logout()">
                    <i class="fas fa-lion text-lion-gold text-2xl mr-3"></i>
                    <span class="text-xl font-bold tracking-wider">COUNTRY LION <span class="text-lion-gold">TRAINING</span></span>
                </div>
                <div id="nav-buttons" class="flex items-center">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN APP CONTAINER -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 relative">
        <div id="app">
            <!-- Content injected here -->
        </div>
        <!-- Global Loading Overlay -->
        <div id="global-loader" class="hidden absolute inset-0 bg-gray-50 bg-opacity-80 flex justify-center items-center z-50 h-full">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-800 text-gray-500 py-6 text-center text-sm mt-auto">
        <p>&copy; 2026 Country Lion Training Assessment. Cloud Edition 3.0</p>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtal9zPioR5LXlHRn3IqGQ2OML5DBXg2A",
            authDomain: "assessments-89dd7.firebaseapp.com",
            projectId: "assessments-89dd7",
            storageBucket: "assessments-89dd7.firebasestorage.app",
            messagingSenderId: "700097828470",
            appId: "1:700097828470:web:95a92b50b3a0ca59ebb157"
        };

        // Initialize Firebase
        let db;
        try {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            console.log("Firebase Connected");
        } catch (error) {
            console.error("Firebase Init Error:", error);
            alert("Database connection failed. Check console.");
        }

        // --- DATABASE SERVICE ---
        const DB = {
            // Seed default data if DB is empty
            seedDefaults: async () => {
                const usersSnap = await getDocs(collection(db, "users"));
                if (!usersSnap.empty) return; // Already has data

                console.log("Seeding default data...");
                const defaultUsers = [
                    { id: 'u1', name: "John Doe", username: "jdoe", pin: "1234", role: 'learner', assigned: [1, 2] },
                    { id: 'u_admin', name: "System Admin", username: "admin", pin: "0000", role: 'admin', assigned: [1, 2] }
                ];
                const defaultQuizzes = [
                    { 
                        id: 1, title: "Site Safety Induction", desc: "Mandatory safety protocols.", displayCount: 3, passMark: 2,
                        questions: [
                            { q: "What color is a prohibition sign?", options: ["Red", "Green", "Blue", "Yellow"], ans: 0, explain: "Prohibition signs are Red." },
                            { q: "What should you do on fire alarm?", options: ["Finish work", "Evacuate", "Hide"], ans: 1, explain: "Evacuate immediately." },
                            { q: "Who is responsible for your PPE?", options: ["Manager", "You", "Client"], ans: 1, explain: "You are responsible." }
                        ]
                    },
                    {
                        id: 2, title: "Manual Handling", desc: "Lifting techniques.", displayCount: 2, passMark: 1,
                        questions: [
                            { q: "Max weight for one person?", options: ["25kg", "50kg", "No limit"], ans: 0, explain: "25kg guideline." },
                            { q: "Keep load...", options: ["Away", "Close to waist", "Above head"], ans: 1, explain: "Keep close to center of gravity." }
                        ]
                    }
                ];

                for (const u of defaultUsers) await setDoc(doc(db, "users", u.id), u);
                for (const q of defaultQuizzes) await setDoc(doc(db, "quizzes", String(q.id)), q);
                console.log("Seeding complete.");
            },

            getAll: async (collName) => {
                const querySnapshot = await getDocs(collection(db, collName));
                let data = [];
                querySnapshot.forEach((doc) => data.push(doc.data()));
                return data;
            },

            getById: async (collName, id) => {
                const docRef = doc(db, collName, String(id));
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            },

            save: async (collName, data) => {
                // Ensure ID is string
                await setDoc(doc(db, collName, String(data.id || data.resultId)), data);
            },

            delete: async (collName, id) => {
                await deleteDoc(doc(db, collName, String(id)));
            }
        };

        // --- APP LOGIC ---
        const App = {
            currentUser: null,
            currentQuizSession: null,
            editingUser: null,
            editingQuiz: null,

            init: async () => {
                // window.app = App; // REMOVED from here
                App.showLoader(true);
                try {
                    await DB.seedDefaults();
                    App.render('login');
                } catch (e) {
                    console.error(e);
                    document.getElementById('app').innerHTML = `<div class="text-center text-red-600 mt-10">Failed to connect to database.<br>Check console for details.</div>`;
                } finally {
                    App.showLoader(false);
                }

                // Click outside listener for dropdown
                window.addEventListener('click', (e) => {
                    const container = document.getElementById('quizInputContainer');
                    const dropdown = document.getElementById('quizDropdown');
                    if (container && dropdown && !container.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            },

            showLoader: (show) => {
                const el = document.getElementById('global-loader');
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            },

            updateNav: () => {
                const nav = document.getElementById('nav-buttons');
                if (App.currentUser) {
                    const roleBadge = App.currentUser.role === 'admin' 
                        ? `<span class="bg-lion-gold text-gray-900 text-xs px-2 py-1 rounded font-bold mr-2">ADMIN</span>` 
                        : '';
                    const adminLink = App.currentUser.role === 'admin'
                        ? `<button onclick="window.app.render('adminDashboard')" class="mr-4 text-sm font-bold text-lion-gold hover:text-yellow-400 transition"><i class="fas fa-tools mr-1"></i> Admin Panel</button>`
                        : '';
                    nav.innerHTML = `<div class="flex items-center">${roleBadge}${adminLink}<span class="mr-4 text-sm text-gray-400 hidden sm:block">${App.currentUser.name}</span><button onclick="window.app.logout()" class="text-sm border border-gray-600 hover:border-white text-gray-300 hover:text-white px-3 py-1 rounded transition">Logout</button></div>`;
                } else {
                    nav.innerHTML = '';
                }
            },

            render: async (viewName, data = null) => {
                const container = document.getElementById('app');
                App.showLoader(true);
                App.updateNav();
                
                try {
                    switch(viewName) {
                        case 'login':
                            container.innerHTML = `
                                <div class="max-w-md mx-auto mt-10 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <div class="text-center mb-6">
                                        <i class="fas fa-user-circle text-5xl text-gray-300 mb-2"></i>
                                        <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                                        <p class="text-gray-500 text-sm">Enter your Username and PIN</p>
                                    </div>
                                    <form onsubmit="event.preventDefault(); window.app.handleLogin()" class="space-y-4">
                                        <div><label class="block text-gray-600 text-xs font-bold mb-1 uppercase">Username</label><input type="text" id="loginUsername" placeholder="e.g. jdoe" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-lion-gold transition"></div>
                                        <div><label class="block text-gray-600 text-xs font-bold mb-1 uppercase">PIN</label><input type="password" id="loginPin" placeholder="****" maxlength="4" class="w-full p-3 border border-gray-300 rounded focus:outline-none focus:border-lion-gold transition font-mono tracking-widest"></div>
                                        <button type="submit" class="w-full bg-lion-gold hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow transition transform hover:scale-[1.02]">Log In</button>
                                    </form>
                                </div>`;
                            break;

                        case 'dashboard':
                            if (!App.currentUser) return App.render('login');
                            const allQuizzes = await DB.getAll("quizzes");
                            const allResults = await DB.getAll("results");
                            const userHistory = allResults.filter(r => r.userId === App.currentUser.id);
                            const myQuizzes = allQuizzes.filter(q => (App.currentUser.assigned || []).includes(q.id));

                            let quizCards = myQuizzes.map(q => {
                                const attempts = userHistory.filter(h => h.quizId === q.id);
                                const lastAttempt = attempts.length ? attempts[attempts.length-1] : null;
                                const isPassed = lastAttempt && lastAttempt.passed;
                                return `
                                    <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300 flex flex-col h-full border-l-4 ${isPassed ? 'border-green-500' : 'border-lion-gold'}">
                                        <div class="p-6 flex-grow">
                                            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl text-gray-800">${q.title}</h3>${isPassed ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">COMPLETED</span>' : '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold">PENDING</span>'}</div>
                                            <p class="text-gray-600 text-sm mb-4">${q.desc}</p>
                                            <div class="text-xs text-gray-500">Pass Mark: ${q.passMark || 'N/A'}<br>Last Score: ${lastAttempt ? lastAttempt.score + '%' : 'Not taken'}</div>
                                        </div>
                                        <div class="bg-gray-50 p-4 border-t border-gray-100"><button onclick="window.app.startQuiz(${q.id})" class="w-full ${isPassed ? 'bg-gray-200 text-gray-600' : 'bg-gray-800 text-white hover:bg-gray-900'} font-bold py-2 rounded transition flex justify-center items-center">${isPassed ? 'Retake Assessment' : 'Start Assessment <i class="fas fa-arrow-right ml-2"></i>'}</button></div>
                                    </div>`;
                            }).join('');
                            
                            if (myQuizzes.length === 0) quizCards = `<div class="col-span-3 text-center py-10 text-gray-500">You have no assessments assigned at this time.</div>`;

                            container.innerHTML = `
                                <div class="fade-in">
                                    <div class="bg-white p-6 rounded-lg shadow-sm mb-8 border-b border-gray-200"><h1 class="text-3xl font-bold text-gray-800">Welcome, <span class="text-lion-gold">${App.currentUser.name}</span></h1><p class="text-gray-600 mt-1">You have <span class="font-bold">${myQuizzes.length}</span> assigned assessments.</p></div>
                                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">${quizCards}</div>
                                </div>`;
                            break;

                        case 'quiz':
                            const session = App.currentQuizSession;
                            if (!session) return App.render('dashboard');
                            let qHtml = session.questions.map((q, idx) => `
                                <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200"><p class="font-semibold text-lg text-gray-800 mb-4"><span class="text-lion-gold font-bold mr-2">Q${idx+1}.</span> ${q.q}</p>
                                <div class="space-y-3">${q.options.map((opt, optIdx) => `<label class="flex items-center p-3 bg-white border border-gray-300 rounded cursor-pointer hover:border-lion-gold hover:bg-yellow-50 transition"><input type="radio" name="q_${idx}" value="${optIdx}" class="w-4 h-4 text-lion-gold focus:ring-lion-gold border-gray-300" required><span class="ml-3 text-gray-700">${opt}</span></label>`).join('')}</div></div>`).join('');
                            container.innerHTML = `
                                <div class="max-w-3xl mx-auto fade-in bg-white p-8 rounded-xl shadow-lg">
                                    <div class="flex justify-between items-center mb-6 pb-4 border-b"><div><h2 class="text-2xl font-bold">${session.title}</h2><p class="text-xs text-gray-500 mt-1">Pass Mark: ${session.passMark} correct</p></div><button onclick="window.app.render('dashboard')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i> Cancel</button></div>
                                    <form id="quizForm" onsubmit="event.preventDefault(); window.app.submitQuiz()">${qHtml}<div class="mt-8 pt-4 border-t border-gray-100 flex justify-end"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow transition text-lg">Submit Assessment</button></div></form>
                                </div>`;
                            break;

                        case 'quizResults':
                            const rId = data;
                            const res = await DB.getById("results", rId);
                            if (!res) { alert("Result not found"); return App.render('dashboard'); }
                            
                            let resHtml = '';
                            if (res.snapshot) {
                                resHtml = res.snapshot.map((item, idx) => {
                                    const isCorrect = item.userAns === item.ans;
                                    const icon = isCorrect ? '<i class="fas fa-check-circle text-green-600"></i>' : '<i class="fas fa-times-circle text-red-600"></i>';
                                    const optsFb = item.options.map((opt, optIdx) => {
                                        let style = "p-2 rounded border border-gray-200 bg-white text-gray-500";
                                        let iconHTML = "";
                                        if (optIdx === item.ans) { style = "p-2 rounded border border-green-500 bg-green-100 text-green-800 font-bold"; iconHTML = '<i class="fas fa-check float-right mt-1"></i>'; }
                                        else if (optIdx === item.userAns && !isCorrect) { style = "p-2 rounded border border-red-500 bg-red-100 text-red-800 font-bold"; iconHTML = '<i class="fas fa-times float-right mt-1"></i>'; }
                                        return `<div class="${style} text-sm mb-1">${opt} ${iconHTML}</div>`;
                                    }).join('');
                                    return `<div class="mb-6 p-5 rounded-lg border-l-4 shadow-sm bg-white ${isCorrect ? 'border-green-500' : 'border-red-500'}"><div class="flex justify-between items-start mb-3"><h4 class="font-bold text-gray-800">Question ${idx+1}</h4><span class="text-xl">${icon}</span></div><p class="text-gray-700 mb-3">${item.q}</p><div class="space-y-1 mb-4">${optsFb}</div><div class="bg-gray-100 p-3 rounded text-sm text-gray-600 border-l-2 border-gray-400"><strong>Explanation:</strong> ${item.explain || "N/A"}</div></div>`;
                                }).join('');
                            } else { resHtml = "<p>Legacy data unavailable.</p>"; }

                            const backAct = App.currentUser.role === 'admin' ? "window.app.render('adminDashboard')" : "window.app.render('dashboard')";
                            container.innerHTML = `
                                <div class="max-w-3xl mx-auto fade-in">
                                    <div class="bg-white p-8 rounded-xl shadow-lg mb-8 text-center border-t-4 ${res.passed ? 'border-green-500' : 'border-red-500'}"><h2 class="text-3xl font-bold mb-2">${res.passed ? 'PASSED' : 'FAILED'}</h2><div class="text-5xl font-bold my-4 ${res.passed ? 'text-green-600' : 'text-red-600'}">${res.score}%</div><p class="text-gray-500 mb-6">User: ${res.userName} | Date: ${new Date(res.date).toLocaleDateString()}</p><button onclick="${backAct}" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-900 transition">Back</button></div>
                                    <div class="space-y-6">${resHtml}</div>
                                </div>`;
                            break;

                        case 'adminDashboard':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const aUsers = await DB.getAll("users");
                            const aResults = await DB.getAll("results");
                            const aQuizzes = await DB.getAll("quizzes");

                            const resRows = aResults.slice().reverse().map(r => `
                                <tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="window.app.viewResult('${r.resultId}')">
                                    <td class="p-4 font-medium">${r.userName}</td>
                                    <td class="p-4 text-gray-600">${r.quizTitle}</td>
                                    <td class="p-4 font-bold ${r.passed ? 'text-green-600' : 'text-red-500'}">${r.score}%</td>
                                    <td class="p-4 text-sm text-gray-500">${new Date(r.date).toLocaleDateString()}</td>
                                </tr>`).join('');

                            const uRows = aUsers.map(u => {
                                const assigns = (u.assigned || []).map(qId => {
                                    const q = aQuizzes.find(x => x.id === qId);
                                    if (!q) return '';
                                    const uRes = aResults.filter(r => r.userId === u.id && r.quizId === qId);
                                    const last = uRes.length ? uRes[uRes.length-1] : null;
                                    if(last) {
                                        const col = last.passed ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
                                        return `<span onclick="window.app.viewResult('${last.resultId}'); event.stopPropagation();" class="cursor-pointer inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border ${col} mr-1 mb-1">${q.title.substring(0,10)}...: ${last.score}%</span>`;
                                    }
                                    return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200 mr-1 mb-1">${q.title.substring(0,10)}...</span>`;
                                }).join('');
                                return `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-gray-800">${u.name}</td><td class="p-4 text-gray-600 font-mono text-sm">${u.username}</td><td class="p-4 flex flex-wrap">${assigns || '-'}</td><td class="p-4 text-right"><button onclick="window.app.editUser('${u.id}')" class="text-sm bg-white border border-gray-300 text-gray-700 px-3 py-1 rounded hover:bg-gray-100">Manage</button></td></tr>`;
                            }).join('');

                            container.innerHTML = `
                                <div class="fade-in space-y-8">
                                    <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-lg shadow-sm"><div><h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2><p class="text-gray-500">Cloud Database Active</p></div><div class="mt-4 md:mt-0 flex gap-3"><button onclick="window.app.render('dashboard')" class="bg-white border border-gray-300 px-4 py-2 rounded">My Assessments</button><button onclick="window.app.render('manageQuizzes')" class="bg-white border border-gray-300 px-4 py-2 rounded">Manage Assessments</button><button onclick="window.app.startCreateUser()" class="bg-lion-gold text-white px-6 py-2 rounded font-bold">+ Create User</button></div></div>
                                    <div class="grid lg:grid-cols-3 gap-8">
                                        <div class="lg:col-span-2 bg-white rounded-lg shadow overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b font-bold text-gray-700">User Database</div><div class="overflow-x-auto max-h-[500px] overflow-y-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10"><tr><th class="p-4">Name</th><th class="p-4">User</th><th class="p-4">Status</th><th class="p-4">Action</th></tr></thead><tbody>${uRows}</tbody></table></div></div>
                                        <div class="bg-white rounded-lg shadow overflow-hidden"><div class="bg-gray-50 px-6 py-4 border-b font-bold text-gray-700">History</div><div class="overflow-x-auto max-h-[500px] overflow-y-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10"><tr><th class="p-4">User</th><th class="p-4">Quiz</th><th class="p-4">Score</th></tr></thead><tbody>${resRows}</tbody></table></div></div>
                                    </div>
                                </div>`;
                            break;

                        case 'manageQuizzes':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const mQuizzes = await DB.getAll("quizzes");
                            const mUsers = await DB.getAll("users");
                            const qRows = mQuizzes.map(q => {
                                const count = mUsers.filter(u => (u.assigned || []).includes(q.id)).length;
                                return `<tr class="border-b hover:bg-gray-50"><td class="p-4 font-bold text-gray-800">${q.title}</td><td class="p-4">${q.questions.length} Qs</td><td class="p-4">${count} Users</td><td class="p-4 text-right"><button onclick="window.app.editQuiz(${q.id})" class="text-blue-600 mr-4">Edit</button><button onclick="window.app.deleteQuiz(${q.id})" class="text-red-500">Delete</button></td></tr>`;
                            }).join('');
                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto fade-in"><div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Assessments</h2><div><button onclick="window.app.render('adminDashboard')" class="text-gray-500 mr-4">Back</button><button onclick="window.app.startCreateQuiz()" class="bg-lion-gold text-white px-6 py-2 rounded font-bold">+ New Assessment</button></div></div>
                                <div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full text-left border-collapse"><thead class="bg-gray-100 text-gray-600 text-xs uppercase"><tr><th class="p-4">Title</th><th class="p-4">Bank</th><th class="p-4">Assigned</th><th class="p-4 text-right">Actions</th></tr></thead><tbody>${qRows || '<tr><td colspan="4" class="p-6 text-center">No assessments found.</td></tr>'}</tbody></table></div></div>`;
                            break;

                        case 'userForm':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const isEdit = !!App.editingUser;
                            const u = App.editingUser || { name: '', username: '', pin: '', role: 'learner', assigned: [] };
                            const formQuizzes = await DB.getAll("quizzes");
                            
                            const assignedTags = (u.assigned || []).map(id => {
                                const q = formQuizzes.find(x => x.id === id);
                                return q ? `<div class="bg-blue-50 border border-blue-200 text-blue-800 rounded px-3 py-1 flex items-center gap-2" data-id="${id}"><span class="text-sm font-medium">${q.title}</span><button type="button" onclick="this.parentElement.remove()" class="text-blue-400 hover:text-blue-600"><i class="fas fa-times"></i></button></div>` : '';
                            }).join('');
                            const ddItems = formQuizzes.map(q => `<div onclick="window.app.addAssignment(${q.id})" data-search="${q.title.toLowerCase()}" class="quiz-option p-3 hover:bg-gray-100 cursor-pointer border-b">${q.title}</div>`).join('');

                            container.innerHTML = `
                                <div class="max-w-2xl mx-auto mt-10 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${isEdit ? 'Manage User' : 'Create New User'}</h2>
                                    <form onsubmit="window.app.handleSaveUser(event)">
                                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Name</label><input type="text" id="formName" value="${u.name}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Username</label><input type="text" id="formUsername" value="${u.username || ''}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">PIN</label><input type="text" id="formPin" value="${u.pin}" maxlength="4" class="w-full p-3 border border-gray-300 rounded text-center"></div>
                                            <div><label class="block text-gray-700 text-sm font-bold mb-2">Role</label><select id="formRole" class="w-full p-3 border border-gray-300 rounded"><option value="learner" ${u.role === 'learner'?'selected':''}>Learner</option><option value="admin" ${u.role === 'admin'?'selected':''}>Admin</option></select></div>
                                        </div>
                                        <div class="mb-6 border-t pt-4"><label class="block text-gray-700 text-sm font-bold mb-3">Assignments</label>
                                            <div id="assigned-container" class="flex flex-wrap gap-2 mb-4 min-h-[40px] p-2 bg-gray-50 rounded border border-gray-200">${assignedTags}</div>
                                            <div class="flex gap-2 relative" id="quizInputContainer"><input type="text" id="quizInput" oninput="window.app.filterQuizzes()" onfocus="window.app.showQuizDropdown()" class="w-full p-3 border border-gray-300 rounded" placeholder="Search assessments..."><div id="quizDropdown" class="hidden absolute z-20 w-full bg-white border border-gray-300 mt-1 max-h-60 overflow-y-auto shadow-xl rounded-md top-12">${ddItems}</div></div>
                                        </div>
                                        <div class="flex justify-between pt-4 border-t"><button type="button" onclick="window.app.render('adminDashboard')" class="text-gray-500">Cancel</button><button type="submit" class="bg-lion-gold text-white font-bold py-2 px-8 rounded shadow">Save</button></div>
                                    </form>
                                </div>`;
                            break;

                        case 'quizForm':
                            if (!App.currentUser || App.currentUser.role !== 'admin') return App.render('login');
                            const isEditQ = !!App.editingQuiz;
                            const q = App.editingQuiz || { title: '', desc: '', questions: [], displayCount: 5, passMark: 4 };
                            if (!isEditQ && q.questions.length === 0) q.questions.push({ q: '', options: ['', '', '', ''], ans: 0, explain: '' });

                            const qBlocks = q.questions.map((quest, idx) => {
                                const opts = quest.options; while(opts.length < 4) opts.push('');
                                return `
                                    <div class="question-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative">
                                        <div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.question-block').remove(); window.app.updateQuizCounts();"><i class="fas fa-trash"></i></div>
                                        <div class="mb-4"><label class="block text-sm font-bold mb-2">Question ${idx+1}</label><input type="text" class="q-text w-full p-3 border border-gray-300 rounded" value="${quest.q}" required></div>
                                        <div class="grid md:grid-cols-2 gap-4 mb-4">${opts.map((opt, i) => `<div class="flex items-center"><input type="radio" name="ans_radio_${idx}" value="${i}" ${quest.ans===i?'checked':''} class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" value="${opt}" required></div>`).join('')}</div>
                                        <div><label class="block text-xs font-bold mb-1">Explanation</label><textarea class="q-explain w-full p-2 border border-gray-300 rounded text-sm">${quest.explain||''}</textarea></div>
                                    </div>`;
                            }).join('');

                            container.innerHTML = `
                                <div class="max-w-4xl mx-auto mt-6 bg-white p-8 rounded-xl shadow-xl fade-in border-t-4 border-lion-gold">
                                    <h2 class="text-2xl font-bold mb-6 text-gray-800">${isEditQ ? 'Edit Assessment' : 'Create New Assessment'}</h2>
                                    <form onsubmit="window.app.handleSaveQuiz(event)">
                                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2">Title</label><input type="text" id="quizTitle" value="${q.title}" required class="w-full p-3 border border-gray-300 rounded text-lg font-bold"></div>
                                            <div class="md:col-span-2"><label class="block text-sm font-bold mb-2">Description</label><input type="text" id="quizDesc" value="${q.desc}" required class="w-full p-3 border border-gray-300 rounded"></div>
                                        </div>
                                        <div class="bg-blue-50 border border-blue-200 p-4 rounded mb-8 grid md:grid-cols-2 gap-6">
                                            <div><label class="block text-sm font-bold mb-1">Display Count</label><input type="number" id="quizDisplayCount" value="${q.displayCount||q.questions.length}" min="1" class="w-full p-2 border border-gray-300 rounded"></div>
                                            <div><label class="block text-sm font-bold mb-1">Pass Mark</label><input type="number" id="quizPassMark" value="${q.passMark||1}" min="1" class="w-full p-2 border border-gray-300 rounded"></div>
                                        </div>
                                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-1">Question Bank <span id="qBankCount" class="text-sm font-normal text-gray-500">(${q.questions.length})</span></h3>
                                        <div id="questions-container">${qBlocks}</div>
                                        <div class="mb-8"><button type="button" onclick="window.app.addQuestionHTML()" class="text-lion-gold border border-lion-gold rounded px-4 py-2 text-sm w-full">+ Add Question</button></div>
                                        <div class="flex justify-between pt-4 border-t"><button type="button" onclick="window.app.render('manageQuizzes')" class="text-gray-500">Cancel</button><button type="submit" class="bg-lion-gold text-white font-bold py-3 px-8 rounded shadow">Save Assessment</button></div>
                                    </form>
                                </div>`;
                            break;
                    }
                } catch (err) {
                    console.error("Render Error:", err);
                    container.innerHTML = `<div class="p-10 text-center text-red-500">Error loading content: ${err.message}</div>`;
                } finally {
                    App.showLoader(false);
                }
            },

            // --- ACTIONS (Async) ---
            handleLogin: async () => {
                App.showLoader(true);
                const uInput = document.getElementById('loginUsername').value.trim().toLowerCase();
                const pInput = document.getElementById('loginPin').value.trim();
                
                // Query Firestore
                const q = query(collection(db, "users"), where("username", "==", uInput), where("pin", "==", pInput));
                const snap = await getDocs(q);
                
                App.showLoader(false);
                if (!snap.empty) {
                    App.currentUser = snap.docs[0].data();
                    App.render(App.currentUser.role === 'admin' ? 'adminDashboard' : 'dashboard');
                } else {
                    alert('Invalid Login. Check Username and PIN.');
                }
            },

            logout: () => { App.currentUser = null; App.currentQuizSession = null; App.render('login'); },

            startCreateUser: () => { App.editingUser = null; App.render('userForm'); },
            
            editUser: async (id) => {
                const user = await DB.getById("users", id);
                if(user) { App.editingUser = user; App.render('userForm'); }
            },

            viewResult: (id) => { App.render('quizResults', id); },

            // Tag & Dropdown Logic
            showQuizDropdown: () => { document.getElementById('quizDropdown').classList.remove('hidden'); },
            filterQuizzes: () => {
                const val = document.getElementById('quizInput').value.toLowerCase();
                document.querySelectorAll('.quiz-option').forEach(el => {
                    el.classList.toggle('hidden', !el.dataset.search.includes(val));
                });
                document.getElementById('quizDropdown').classList.remove('hidden');
            },
            addAssignment: async (id = null) => {
                App.showLoader(true); // Since we might need to fetch
                const allQ = await DB.getAll("quizzes");
                App.showLoader(false);
                
                let quiz = id ? allQ.find(q => q.id === id) : null;
                
                const container = document.getElementById('assigned-container');
                if(!quiz || container.querySelector(`[data-id="${quiz.id}"]`)) {
                    document.getElementById('quizInput').value = '';
                    return;
                }
                const tag = document.createElement('div');
                tag.className = "bg-blue-50 border border-blue-200 text-blue-800 rounded px-3 py-1 flex items-center gap-2";
                tag.dataset.id = quiz.id;
                tag.innerHTML = `<span class="text-sm font-medium">${quiz.title}</span><button type="button" onclick="this.parentElement.remove()" class="text-blue-400 hover:text-blue-600"><i class="fas fa-times"></i></button>`;
                container.appendChild(tag);
                document.getElementById('quizInput').value = '';
                document.getElementById('quizDropdown').classList.add('hidden');
            },

            handleSaveUser: async (e) => {
                e.preventDefault();
                App.showLoader(true);
                const name = document.getElementById('formName').value.trim();
                const username = document.getElementById('formUsername').value.trim();
                const pin = document.getElementById('formPin').value.trim();
                const role = document.getElementById('formRole').value;
                const assigned = Array.from(document.querySelectorAll('#assigned-container > div')).map(d => parseInt(d.dataset.id));

                if(App.editingUser) {
                    await DB.save("users", { ...App.editingUser, name, username, pin, role, assigned });
                } else {
                    // Check duplicate
                    const q = query(collection(db, "users"), where("username", "==", username));
                    const snap = await getDocs(q);
                    if(!snap.empty) { alert("Username taken"); App.showLoader(false); return; }
                    await DB.save("users", { id: 'u' + Date.now(), name, username, pin, role, assigned });
                }
                alert("Saved!");
                App.editingUser = null;
                App.render('adminDashboard');
            },

            startQuiz: async (id) => {
                App.showLoader(true);
                const quiz = await DB.getById("quizzes", id);
                App.showLoader(false);
                if(!quiz) return;

                // Randomize
                const pool = [...quiz.questions];
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                const displayCount = quiz.displayCount || pool.length;
                const selected = pool.slice(0, displayCount);
                const passMark = quiz.passMark || Math.ceil(selected.length * 0.7);

                App.currentQuizSession = { quizId: quiz.id, title: quiz.title, questions: selected, passMark };
                App.render('quiz');
            },

            submitQuiz: async () => {
                const session = App.currentQuizSession;
                const formData = new FormData(document.getElementById('quizForm'));
                let correctCount = 0;
                
                const snapshot = session.questions.map((q, idx) => {
                    const val = formData.get(`q_${idx}`);
                    const userAns = val ? parseInt(val) : -1;
                    if (userAns === q.ans) correctCount++;
                    return { ...q, userAns };
                });

                const total = session.questions.length;
                const score = Math.round((correctCount / total) * 100);
                const passed = correctCount >= session.passMark;
                
                const result = {
                    resultId: 'r' + Date.now(),
                    userId: App.currentUser.id,
                    userName: App.currentUser.name,
                    quizId: session.quizId,
                    quizTitle: session.title,
                    score, passed, snapshot,
                    date: new Date().toISOString()
                };

                App.showLoader(true);
                await DB.save("results", result);
                App.showLoader(false);
                App.render('quizResults', result.resultId);
            },

            // Quiz Management Actions
            startCreateQuiz: () => { App.editingQuiz = null; App.render('quizForm'); },
            editQuiz: async (id) => { 
                App.showLoader(true);
                const q = await DB.getById("quizzes", id);
                App.showLoader(false);
                if(q) { App.editingQuiz = q; App.render('quizForm'); }
            },
            deleteQuiz: async (id) => {
                if(!confirm("Delete this assessment?")) return;
                App.showLoader(true);
                await DB.delete("quizzes", id);
                // Also remove assignments (optional but good)
                const allUsers = await DB.getAll("users");
                for(const u of allUsers) {
                    if((u.assigned || []).includes(id)) {
                        u.assigned = u.assigned.filter(a => a !== id);
                        await DB.save("users", u);
                    }
                }
                App.showLoader(false);
                App.render('manageQuizzes');
            },
            addQuestionHTML: () => {
                const container = document.getElementById('questions-container');
                const idx = container.children.length;
                const div = document.createElement('div');
                div.className = "question-block bg-gray-50 p-6 rounded border border-gray-200 mb-6 relative fade-in";
                div.innerHTML = `<div class="absolute top-4 right-4 text-red-400 cursor-pointer" onclick="this.closest('.question-block').remove(); window.app.updateQuizCounts();"><i class="fas fa-trash"></i></div>
                    <div class="mb-4"><label class="block text-sm font-bold mb-2">New Question</label><input type="text" class="q-text w-full p-3 border border-gray-300 rounded" placeholder="Question text..." required></div>
                    <div class="grid md:grid-cols-2 gap-4 mb-4"><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="0" checked class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 1"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="1" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 2"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="2" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 3"></div><div class="flex items-center"><input type="radio" name="ans_new_${idx}" value="3" class="mr-2"><input type="text" class="q-opt w-full p-2 border border-gray-300 rounded text-sm" placeholder="Opt 4"></div></div>
                    <div><label class="block text-xs font-bold mb-1">Explanation</label><textarea class="q-explain w-full p-2 border border-gray-300 rounded text-sm"></textarea></div>`;
                container.appendChild(div);
                window.app.updateQuizCounts();
            },
            updateQuizCounts: () => { document.getElementById('qBankCount').textContent = `(${document.getElementById('questions-container').children.length})`; },
            handleSaveQuiz: async (e) => {
                e.preventDefault();
                const title = document.getElementById('quizTitle').value.trim();
                const desc = document.getElementById('quizDesc').value.trim();
                const displayCount = parseInt(document.getElementById('quizDisplayCount').value);
                const passMark = parseInt(document.getElementById('quizPassMark').value);
                
                const qBlocks = document.querySelectorAll('.question-block');
                const questions = Array.from(qBlocks).map(b => ({
                    q: b.querySelector('.q-text').value,
                    options: Array.from(b.querySelectorAll('.q-opt')).map(o => o.value),
                    ans: parseInt(b.querySelector('input[type=radio]:checked').value),
                    explain: b.querySelector('.q-explain').value
                }));

                const quizData = { 
                    id: App.editingQuiz ? App.editingQuiz.id : Date.now(),
                    title, desc, questions, displayCount, passMark 
                };

                App.showLoader(true);
                await DB.save("quizzes", quizData);
                App.showLoader(false);
                App.editingQuiz = null;
                App.render('manageQuizzes');
            }
        };

        // EXPOSE APP GLOBALLY
        window.app = App;

        // Start App
        // Use addEventListener to avoid overwriting other scripts and ensure DOM is ready
        window.addEventListener('load', () => window.app.init());
    </script>
</body>
</html>
